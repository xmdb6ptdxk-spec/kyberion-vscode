"use strict";var ys=Object.create;var he=Object.defineProperty;var _s=Object.getOwnPropertyDescriptor;var xs=Object.getOwnPropertyNames;var ws=Object.getPrototypeOf,Ss=Object.prototype.hasOwnProperty;var S=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),ks=(n,e)=>{for(var t in e)he(n,t,{get:e[t],enumerable:!0})},it=(n,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of xs(e))!Ss.call(n,r)&&r!==t&&he(n,r,{get:()=>e[r],enumerable:!(s=_s(e,r))||s.enumerable});return n};var w=(n,e,t)=>(t=n!=null?ys(ws(n)):{},it(e||!n||!n.__esModule?he(t,"default",{value:n,enumerable:!0}):t,n)),Es=n=>it(he({},"__esModule",{value:!0}),n);var I=S((er,ct)=>{"use strict";var ot=["nodebuffer","arraybuffer","fragments"],at=typeof Blob<"u";at&&ot.push("blob");ct.exports={BINARY_TYPES:ot,EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",hasBlob:at,kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}}});var ne=S((tr,ue)=>{"use strict";var{EMPTY_BUFFER:Ps}=I(),Be=Buffer[Symbol.species];function Cs(n,e){if(n.length===0)return Ps;if(n.length===1)return n[0];let t=Buffer.allocUnsafe(e),s=0;for(let r=0;r<n.length;r++){let i=n[r];t.set(i,s),s+=i.length}return s<e?new Be(t.buffer,t.byteOffset,s):t}function lt(n,e,t,s,r){for(let i=0;i<r;i++)t[s+i]=n[i]^e[i&3]}function dt(n,e){for(let t=0;t<n.length;t++)n[t]^=e[t&3]}function Ts(n){return n.length===n.buffer.byteLength?n.buffer:n.buffer.slice(n.byteOffset,n.byteOffset+n.length)}function Ie(n){if(Ie.readOnly=!0,Buffer.isBuffer(n))return n;let e;return n instanceof ArrayBuffer?e=new Be(n):ArrayBuffer.isView(n)?e=new Be(n.buffer,n.byteOffset,n.byteLength):(e=Buffer.from(n),Ie.readOnly=!1),e}ue.exports={concat:Cs,mask:lt,toArrayBuffer:Ts,toBuffer:Ie,unmask:dt};if(!process.env.WS_NO_BUFFER_UTIL)try{let n=require("bufferutil");ue.exports.mask=function(e,t,s,r,i){i<48?lt(e,t,s,r,i):n.mask(e,t,s,r,i)},ue.exports.unmask=function(e,t){e.length<32?dt(e,t):n.unmask(e,t)}}catch{}});var ft=S((sr,ut)=>{"use strict";var ht=Symbol("kDone"),Oe=Symbol("kRun"),De=class{constructor(e){this[ht]=()=>{this.pending--,this[Oe]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[Oe]()}[Oe](){if(this.pending!==this.concurrency&&this.jobs.length){let e=this.jobs.shift();this.pending++,e(this[ht])}}};ut.exports=De});var ie=S((nr,bt)=>{"use strict";var re=require("zlib"),pt=ne(),Ms=ft(),{kStatusCode:gt}=I(),Fs=Buffer[Symbol.species],Bs=Buffer.from([0,0,255,255]),pe=Symbol("permessage-deflate"),O=Symbol("total-length"),G=Symbol("callback"),A=Symbol("buffers"),K=Symbol("error"),fe,Ne=class{constructor(e,t,s){if(this._maxPayload=s|0,this._options=e||{},this._threshold=this._options.threshold!==void 0?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!fe){let r=this._options.concurrencyLimit!==void 0?this._options.concurrencyLimit:10;fe=new Ms(r)}}static get extensionName(){return"permessage-deflate"}offer(){let e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:this._options.clientMaxWindowBits==null&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){let e=this._deflate[G];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){let t=this._options,s=e.find(r=>!(t.serverNoContextTakeover===!1&&r.server_no_context_takeover||r.server_max_window_bits&&(t.serverMaxWindowBits===!1||typeof t.serverMaxWindowBits=="number"&&t.serverMaxWindowBits>r.server_max_window_bits)||typeof t.clientMaxWindowBits=="number"&&!r.client_max_window_bits));if(!s)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(s.server_no_context_takeover=!0),t.clientNoContextTakeover&&(s.client_no_context_takeover=!0),typeof t.serverMaxWindowBits=="number"&&(s.server_max_window_bits=t.serverMaxWindowBits),typeof t.clientMaxWindowBits=="number"?s.client_max_window_bits=t.clientMaxWindowBits:(s.client_max_window_bits===!0||t.clientMaxWindowBits===!1)&&delete s.client_max_window_bits,s}acceptAsClient(e){let t=e[0];if(this._options.clientNoContextTakeover===!1&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(!t.client_max_window_bits)typeof this._options.clientMaxWindowBits=="number"&&(t.client_max_window_bits=this._options.clientMaxWindowBits);else if(this._options.clientMaxWindowBits===!1||typeof this._options.clientMaxWindowBits=="number"&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"');return t}normalizeParams(e){return e.forEach(t=>{Object.keys(t).forEach(s=>{let r=t[s];if(r.length>1)throw new Error(`Parameter "${s}" must have only a single value`);if(r=r[0],s==="client_max_window_bits"){if(r!==!0){let i=+r;if(!Number.isInteger(i)||i<8||i>15)throw new TypeError(`Invalid value for parameter "${s}": ${r}`);r=i}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${s}": ${r}`)}else if(s==="server_max_window_bits"){let i=+r;if(!Number.isInteger(i)||i<8||i>15)throw new TypeError(`Invalid value for parameter "${s}": ${r}`);r=i}else if(s==="client_no_context_takeover"||s==="server_no_context_takeover"){if(r!==!0)throw new TypeError(`Invalid value for parameter "${s}": ${r}`)}else throw new Error(`Unknown parameter "${s}"`);t[s]=r})}),e}decompress(e,t,s){fe.add(r=>{this._decompress(e,t,(i,o)=>{r(),s(i,o)})})}compress(e,t,s){fe.add(r=>{this._compress(e,t,(i,o)=>{r(),s(i,o)})})}_decompress(e,t,s){let r=this._isServer?"client":"server";if(!this._inflate){let i=`${r}_max_window_bits`,o=typeof this.params[i]!="number"?re.Z_DEFAULT_WINDOWBITS:this.params[i];this._inflate=re.createInflateRaw({...this._options.zlibInflateOptions,windowBits:o}),this._inflate[pe]=this,this._inflate[O]=0,this._inflate[A]=[],this._inflate.on("error",Os),this._inflate.on("data",mt)}this._inflate[G]=s,this._inflate.write(e),t&&this._inflate.write(Bs),this._inflate.flush(()=>{let i=this._inflate[K];if(i){this._inflate.close(),this._inflate=null,s(i);return}let o=pt.concat(this._inflate[A],this._inflate[O]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[O]=0,this._inflate[A]=[],t&&this.params[`${r}_no_context_takeover`]&&this._inflate.reset()),s(null,o)})}_compress(e,t,s){let r=this._isServer?"server":"client";if(!this._deflate){let i=`${r}_max_window_bits`,o=typeof this.params[i]!="number"?re.Z_DEFAULT_WINDOWBITS:this.params[i];this._deflate=re.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:o}),this._deflate[O]=0,this._deflate[A]=[],this._deflate.on("data",Is)}this._deflate[G]=s,this._deflate.write(e),this._deflate.flush(re.Z_SYNC_FLUSH,()=>{if(!this._deflate)return;let i=pt.concat(this._deflate[A],this._deflate[O]);t&&(i=new Fs(i.buffer,i.byteOffset,i.length-4)),this._deflate[G]=null,this._deflate[O]=0,this._deflate[A]=[],t&&this.params[`${r}_no_context_takeover`]&&this._deflate.reset(),s(null,i)})}};bt.exports=Ne;function Is(n){this[A].push(n),this[O]+=n.length}function mt(n){if(this[O]+=n.length,this[pe]._maxPayload<1||this[O]<=this[pe]._maxPayload){this[A].push(n);return}this[K]=new RangeError("Max payload size exceeded"),this[K].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[K][gt]=1009,this.removeListener("data",mt),this.reset()}function Os(n){if(this[pe]._inflate=null,this[K]){this[G](this[K]);return}n[gt]=1007,this[G](n)}});var Y=S((rr,ge)=>{"use strict";var{isUtf8:vt}=require("buffer"),{hasBlob:Ds}=I(),Ns=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function Ls(n){return n>=1e3&&n<=1014&&n!==1004&&n!==1005&&n!==1006||n>=3e3&&n<=4999}function Le(n){let e=n.length,t=0;for(;t<e;)if((n[t]&128)===0)t++;else if((n[t]&224)===192){if(t+1===e||(n[t+1]&192)!==128||(n[t]&254)===192)return!1;t+=2}else if((n[t]&240)===224){if(t+2>=e||(n[t+1]&192)!==128||(n[t+2]&192)!==128||n[t]===224&&(n[t+1]&224)===128||n[t]===237&&(n[t+1]&224)===160)return!1;t+=3}else if((n[t]&248)===240){if(t+3>=e||(n[t+1]&192)!==128||(n[t+2]&192)!==128||(n[t+3]&192)!==128||n[t]===240&&(n[t+1]&240)===128||n[t]===244&&n[t+1]>143||n[t]>244)return!1;t+=4}else return!1;return!0}function As(n){return Ds&&typeof n=="object"&&typeof n.arrayBuffer=="function"&&typeof n.type=="string"&&typeof n.stream=="function"&&(n[Symbol.toStringTag]==="Blob"||n[Symbol.toStringTag]==="File")}ge.exports={isBlob:As,isValidStatusCode:Ls,isValidUTF8:Le,tokenChars:Ns};if(vt)ge.exports.isValidUTF8=function(n){return n.length<24?Le(n):vt(n)};else if(!process.env.WS_NO_UTF_8_VALIDATE)try{let n=require("utf-8-validate");ge.exports.isValidUTF8=function(e){return e.length<32?Le(e):n(e)}}catch{}});var je=S((ir,Et)=>{"use strict";var{Writable:Rs}=require("stream"),yt=ie(),{BINARY_TYPES:Us,EMPTY_BUFFER:_t,kStatusCode:Ws,kWebSocket:js}=I(),{concat:Ae,toArrayBuffer:Hs,unmask:qs}=ne(),{isValidStatusCode:Vs,isValidUTF8:xt}=Y(),me=Buffer[Symbol.species],E=0,wt=1,St=2,kt=3,Re=4,Ue=5,be=6,We=class extends Rs{constructor(e={}){super(),this._allowSynchronousEvents=e.allowSynchronousEvents!==void 0?e.allowSynchronousEvents:!0,this._binaryType=e.binaryType||Us[0],this._extensions=e.extensions||{},this._isServer=!!e.isServer,this._maxPayload=e.maxPayload|0,this._skipUTF8Validation=!!e.skipUTF8Validation,this[js]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._errored=!1,this._loop=!1,this._state=E}_write(e,t,s){if(this._opcode===8&&this._state==E)return s();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(s)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){let s=this._buffers[0];return this._buffers[0]=new me(s.buffer,s.byteOffset+e,s.length-e),new me(s.buffer,s.byteOffset,e)}let t=Buffer.allocUnsafe(e);do{let s=this._buffers[0],r=t.length-e;e>=s.length?t.set(this._buffers.shift(),r):(t.set(new Uint8Array(s.buffer,s.byteOffset,e),r),this._buffers[0]=new me(s.buffer,s.byteOffset+e,s.length-e)),e-=s.length}while(e>0);return t}startLoop(e){this._loop=!0;do switch(this._state){case E:this.getInfo(e);break;case wt:this.getPayloadLength16(e);break;case St:this.getPayloadLength64(e);break;case kt:this.getMask();break;case Re:this.getData(e);break;case Ue:case be:this._loop=!1;return}while(this._loop);this._errored||e()}getInfo(e){if(this._bufferedBytes<2){this._loop=!1;return}let t=this.consume(2);if((t[0]&48)!==0){let r=this.createError(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3");e(r);return}let s=(t[0]&64)===64;if(s&&!this._extensions[yt.extensionName]){let r=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(r);return}if(this._fin=(t[0]&128)===128,this._opcode=t[0]&15,this._payloadLength=t[1]&127,this._opcode===0){if(s){let r=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(r);return}if(!this._fragmented){let r=this.createError(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE");e(r);return}this._opcode=this._fragmented}else if(this._opcode===1||this._opcode===2){if(this._fragmented){let r=this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");e(r);return}this._compressed=s}else if(this._opcode>7&&this._opcode<11){if(!this._fin){let r=this.createError(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN");e(r);return}if(s){let r=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(r);return}if(this._payloadLength>125||this._opcode===8&&this._payloadLength===1){let r=this.createError(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH");e(r);return}}else{let r=this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");e(r);return}if(!this._fin&&!this._fragmented&&(this._fragmented=this._opcode),this._masked=(t[1]&128)===128,this._isServer){if(!this._masked){let r=this.createError(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK");e(r);return}}else if(this._masked){let r=this.createError(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK");e(r);return}this._payloadLength===126?this._state=wt:this._payloadLength===127?this._state=St:this.haveLength(e)}getPayloadLength16(e){if(this._bufferedBytes<2){this._loop=!1;return}this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength(e)}getPayloadLength64(e){if(this._bufferedBytes<8){this._loop=!1;return}let t=this.consume(8),s=t.readUInt32BE(0);if(s>Math.pow(2,21)-1){let r=this.createError(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH");e(r);return}this._payloadLength=s*Math.pow(2,32)+t.readUInt32BE(4),this.haveLength(e)}haveLength(e){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0)){let t=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");e(t);return}this._masked?this._state=kt:this._state=Re}getMask(){if(this._bufferedBytes<4){this._loop=!1;return}this._mask=this.consume(4),this._state=Re}getData(e){let t=_t;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength){this._loop=!1;return}t=this.consume(this._payloadLength),this._masked&&(this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3])!==0&&qs(t,this._mask)}if(this._opcode>7){this.controlMessage(t,e);return}if(this._compressed){this._state=Ue,this.decompress(t,e);return}t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage(e)}decompress(e,t){this._extensions[yt.extensionName].decompress(e,this._fin,(r,i)=>{if(r)return t(r);if(i.length){if(this._messageLength+=i.length,this._messageLength>this._maxPayload&&this._maxPayload>0){let o=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");t(o);return}this._fragments.push(i)}this.dataMessage(t),this._state===E&&this.startLoop(t)})}dataMessage(e){if(!this._fin){this._state=E;return}let t=this._messageLength,s=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],this._opcode===2){let r;this._binaryType==="nodebuffer"?r=Ae(s,t):this._binaryType==="arraybuffer"?r=Hs(Ae(s,t)):this._binaryType==="blob"?r=new Blob(s):r=s,this._allowSynchronousEvents?(this.emit("message",r,!0),this._state=E):(this._state=be,setImmediate(()=>{this.emit("message",r,!0),this._state=E,this.startLoop(e)}))}else{let r=Ae(s,t);if(!this._skipUTF8Validation&&!xt(r)){let i=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");e(i);return}this._state===Ue||this._allowSynchronousEvents?(this.emit("message",r,!1),this._state=E):(this._state=be,setImmediate(()=>{this.emit("message",r,!1),this._state=E,this.startLoop(e)}))}}controlMessage(e,t){if(this._opcode===8){if(e.length===0)this._loop=!1,this.emit("conclude",1005,_t),this.end();else{let s=e.readUInt16BE(0);if(!Vs(s)){let i=this.createError(RangeError,`invalid status code ${s}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");t(i);return}let r=new me(e.buffer,e.byteOffset+2,e.length-2);if(!this._skipUTF8Validation&&!xt(r)){let i=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");t(i);return}this._loop=!1,this.emit("conclude",s,r),this.end()}this._state=E;return}this._allowSynchronousEvents?(this.emit(this._opcode===9?"ping":"pong",e),this._state=E):(this._state=be,setImmediate(()=>{this.emit(this._opcode===9?"ping":"pong",e),this._state=E,this.startLoop(t)}))}createError(e,t,s,r,i){this._loop=!1,this._errored=!0;let o=new e(s?`Invalid WebSocket frame: ${t}`:t);return Error.captureStackTrace(o,this.createError),o.code=i,o[Ws]=r,o}};Et.exports=We});var Ve=S((ar,Tt)=>{"use strict";var{Duplex:or}=require("stream"),{randomFillSync:$s}=require("crypto"),Pt=ie(),{EMPTY_BUFFER:zs,kWebSocket:Gs,NOOP:Ks}=I(),{isBlob:Q,isValidStatusCode:Ys}=Y(),{mask:Ct,toBuffer:W}=ne(),P=Symbol("kByteLength"),Qs=Buffer.alloc(4),ve=8*1024,j,J=ve,C=0,Js=1,Zs=2,He=class n{constructor(e,t,s){this._extensions=t||{},s&&(this._generateMask=s,this._maskBuffer=Buffer.alloc(4)),this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._queue=[],this._state=C,this.onerror=Ks,this[Gs]=void 0}static frame(e,t){let s,r=!1,i=2,o=!1;t.mask&&(s=t.maskBuffer||Qs,t.generateMask?t.generateMask(s):(J===ve&&(j===void 0&&(j=Buffer.alloc(ve)),$s(j,0,ve),J=0),s[0]=j[J++],s[1]=j[J++],s[2]=j[J++],s[3]=j[J++]),o=(s[0]|s[1]|s[2]|s[3])===0,i=6);let a;typeof e=="string"?(!t.mask||o)&&t[P]!==void 0?a=t[P]:(e=Buffer.from(e),a=e.length):(a=e.length,r=t.mask&&t.readOnly&&!o);let l=a;a>=65536?(i+=8,l=127):a>125&&(i+=2,l=126);let c=Buffer.allocUnsafe(r?a+i:i);return c[0]=t.fin?t.opcode|128:t.opcode,t.rsv1&&(c[0]|=64),c[1]=l,l===126?c.writeUInt16BE(a,2):l===127&&(c[2]=c[3]=0,c.writeUIntBE(a,4,6)),t.mask?(c[1]|=128,c[i-4]=s[0],c[i-3]=s[1],c[i-2]=s[2],c[i-1]=s[3],o?[c,e]:r?(Ct(e,s,c,i,a),[c]):(Ct(e,s,e,0,a),[c,e])):[c,e]}close(e,t,s,r){let i;if(e===void 0)i=zs;else{if(typeof e!="number"||!Ys(e))throw new TypeError("First argument must be a valid error code number");if(t===void 0||!t.length)i=Buffer.allocUnsafe(2),i.writeUInt16BE(e,0);else{let a=Buffer.byteLength(t);if(a>123)throw new RangeError("The message must not be greater than 123 bytes");i=Buffer.allocUnsafe(2+a),i.writeUInt16BE(e,0),typeof t=="string"?i.write(t,2):i.set(t,2)}}let o={[P]:i.length,fin:!0,generateMask:this._generateMask,mask:s,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};this._state!==C?this.enqueue([this.dispatch,i,!1,o,r]):this.sendFrame(n.frame(i,o),r)}ping(e,t,s){let r,i;if(typeof e=="string"?(r=Buffer.byteLength(e),i=!1):Q(e)?(r=e.size,i=!1):(e=W(e),r=e.length,i=W.readOnly),r>125)throw new RangeError("The data size must not be greater than 125 bytes");let o={[P]:r,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:9,readOnly:i,rsv1:!1};Q(e)?this._state!==C?this.enqueue([this.getBlobData,e,!1,o,s]):this.getBlobData(e,!1,o,s):this._state!==C?this.enqueue([this.dispatch,e,!1,o,s]):this.sendFrame(n.frame(e,o),s)}pong(e,t,s){let r,i;if(typeof e=="string"?(r=Buffer.byteLength(e),i=!1):Q(e)?(r=e.size,i=!1):(e=W(e),r=e.length,i=W.readOnly),r>125)throw new RangeError("The data size must not be greater than 125 bytes");let o={[P]:r,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:10,readOnly:i,rsv1:!1};Q(e)?this._state!==C?this.enqueue([this.getBlobData,e,!1,o,s]):this.getBlobData(e,!1,o,s):this._state!==C?this.enqueue([this.dispatch,e,!1,o,s]):this.sendFrame(n.frame(e,o),s)}send(e,t,s){let r=this._extensions[Pt.extensionName],i=t.binary?2:1,o=t.compress,a,l;typeof e=="string"?(a=Buffer.byteLength(e),l=!1):Q(e)?(a=e.size,l=!1):(e=W(e),a=e.length,l=W.readOnly),this._firstFragment?(this._firstFragment=!1,o&&r&&r.params[r._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(o=a>=r._threshold),this._compress=o):(o=!1,i=0),t.fin&&(this._firstFragment=!0);let c={[P]:a,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:i,readOnly:l,rsv1:o};Q(e)?this._state!==C?this.enqueue([this.getBlobData,e,this._compress,c,s]):this.getBlobData(e,this._compress,c,s):this._state!==C?this.enqueue([this.dispatch,e,this._compress,c,s]):this.dispatch(e,this._compress,c,s)}getBlobData(e,t,s,r){this._bufferedBytes+=s[P],this._state=Zs,e.arrayBuffer().then(i=>{if(this._socket.destroyed){let a=new Error("The socket was closed while the blob was being read");process.nextTick(qe,this,a,r);return}this._bufferedBytes-=s[P];let o=W(i);t?this.dispatch(o,t,s,r):(this._state=C,this.sendFrame(n.frame(o,s),r),this.dequeue())}).catch(i=>{process.nextTick(Xs,this,i,r)})}dispatch(e,t,s,r){if(!t){this.sendFrame(n.frame(e,s),r);return}let i=this._extensions[Pt.extensionName];this._bufferedBytes+=s[P],this._state=Js,i.compress(e,s.fin,(o,a)=>{if(this._socket.destroyed){let l=new Error("The socket was closed while data was being compressed");qe(this,l,r);return}this._bufferedBytes-=s[P],this._state=C,s.readOnly=!1,this.sendFrame(n.frame(a,s),r),this.dequeue()})}dequeue(){for(;this._state===C&&this._queue.length;){let e=this._queue.shift();this._bufferedBytes-=e[3][P],Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[3][P],this._queue.push(e)}sendFrame(e,t){e.length===2?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}};Tt.exports=He;function qe(n,e,t){typeof t=="function"&&t(e);for(let s=0;s<n._queue.length;s++){let r=n._queue[s],i=r[r.length-1];typeof i=="function"&&i(e)}}function Xs(n,e,t){qe(n,e,t),n.onerror(e)}});var At=S((cr,Lt)=>{"use strict";var{kForOnEventAttribute:oe,kListener:$e}=I(),Mt=Symbol("kCode"),Ft=Symbol("kData"),Bt=Symbol("kError"),It=Symbol("kMessage"),Ot=Symbol("kReason"),Z=Symbol("kTarget"),Dt=Symbol("kType"),Nt=Symbol("kWasClean"),D=class{constructor(e){this[Z]=null,this[Dt]=e}get target(){return this[Z]}get type(){return this[Dt]}};Object.defineProperty(D.prototype,"target",{enumerable:!0});Object.defineProperty(D.prototype,"type",{enumerable:!0});var H=class extends D{constructor(e,t={}){super(e),this[Mt]=t.code===void 0?0:t.code,this[Ot]=t.reason===void 0?"":t.reason,this[Nt]=t.wasClean===void 0?!1:t.wasClean}get code(){return this[Mt]}get reason(){return this[Ot]}get wasClean(){return this[Nt]}};Object.defineProperty(H.prototype,"code",{enumerable:!0});Object.defineProperty(H.prototype,"reason",{enumerable:!0});Object.defineProperty(H.prototype,"wasClean",{enumerable:!0});var X=class extends D{constructor(e,t={}){super(e),this[Bt]=t.error===void 0?null:t.error,this[It]=t.message===void 0?"":t.message}get error(){return this[Bt]}get message(){return this[It]}};Object.defineProperty(X.prototype,"error",{enumerable:!0});Object.defineProperty(X.prototype,"message",{enumerable:!0});var ae=class extends D{constructor(e,t={}){super(e),this[Ft]=t.data===void 0?null:t.data}get data(){return this[Ft]}};Object.defineProperty(ae.prototype,"data",{enumerable:!0});var en={addEventListener(n,e,t={}){for(let r of this.listeners(n))if(!t[oe]&&r[$e]===e&&!r[oe])return;let s;if(n==="message")s=function(i,o){let a=new ae("message",{data:o?i:i.toString()});a[Z]=this,ye(e,this,a)};else if(n==="close")s=function(i,o){let a=new H("close",{code:i,reason:o.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});a[Z]=this,ye(e,this,a)};else if(n==="error")s=function(i){let o=new X("error",{error:i,message:i.message});o[Z]=this,ye(e,this,o)};else if(n==="open")s=function(){let i=new D("open");i[Z]=this,ye(e,this,i)};else return;s[oe]=!!t[oe],s[$e]=e,t.once?this.once(n,s):this.on(n,s)},removeEventListener(n,e){for(let t of this.listeners(n))if(t[$e]===e&&!t[oe]){this.removeListener(n,t);break}}};Lt.exports={CloseEvent:H,ErrorEvent:X,Event:D,EventTarget:en,MessageEvent:ae};function ye(n,e,t){typeof n=="object"&&n.handleEvent?n.handleEvent.call(n,t):n.call(e,t)}});var ze=S((lr,Rt)=>{"use strict";var{tokenChars:ce}=Y();function M(n,e,t){n[e]===void 0?n[e]=[t]:n[e].push(t)}function tn(n){let e=Object.create(null),t=Object.create(null),s=!1,r=!1,i=!1,o,a,l=-1,c=-1,d=-1,h=0;for(;h<n.length;h++)if(c=n.charCodeAt(h),o===void 0)if(d===-1&&ce[c]===1)l===-1&&(l=h);else if(h!==0&&(c===32||c===9))d===-1&&l!==-1&&(d=h);else if(c===59||c===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${h}`);d===-1&&(d=h);let b=n.slice(l,d);c===44?(M(e,b,t),t=Object.create(null)):o=b,l=d=-1}else throw new SyntaxError(`Unexpected character at index ${h}`);else if(a===void 0)if(d===-1&&ce[c]===1)l===-1&&(l=h);else if(c===32||c===9)d===-1&&l!==-1&&(d=h);else if(c===59||c===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${h}`);d===-1&&(d=h),M(t,n.slice(l,d),!0),c===44&&(M(e,o,t),t=Object.create(null),o=void 0),l=d=-1}else if(c===61&&l!==-1&&d===-1)a=n.slice(l,h),l=d=-1;else throw new SyntaxError(`Unexpected character at index ${h}`);else if(r){if(ce[c]!==1)throw new SyntaxError(`Unexpected character at index ${h}`);l===-1?l=h:s||(s=!0),r=!1}else if(i)if(ce[c]===1)l===-1&&(l=h);else if(c===34&&l!==-1)i=!1,d=h;else if(c===92)r=!0;else throw new SyntaxError(`Unexpected character at index ${h}`);else if(c===34&&n.charCodeAt(h-1)===61)i=!0;else if(d===-1&&ce[c]===1)l===-1&&(l=h);else if(l!==-1&&(c===32||c===9))d===-1&&(d=h);else if(c===59||c===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${h}`);d===-1&&(d=h);let b=n.slice(l,d);s&&(b=b.replace(/\\/g,""),s=!1),M(t,a,b),c===44&&(M(e,o,t),t=Object.create(null),o=void 0),a=void 0,l=d=-1}else throw new SyntaxError(`Unexpected character at index ${h}`);if(l===-1||i||c===32||c===9)throw new SyntaxError("Unexpected end of input");d===-1&&(d=h);let p=n.slice(l,d);return o===void 0?M(e,p,t):(a===void 0?M(t,p,!0):s?M(t,a,p.replace(/\\/g,"")):M(t,a,p),M(e,o,t)),e}function sn(n){return Object.keys(n).map(e=>{let t=n[e];return Array.isArray(t)||(t=[t]),t.map(s=>[e].concat(Object.keys(s).map(r=>{let i=s[r];return Array.isArray(i)||(i=[i]),i.map(o=>o===!0?r:`${r}=${o}`).join("; ")})).join("; ")).join(", ")}).join(", ")}Rt.exports={format:sn,parse:tn}});var Se=S((ur,Qt)=>{"use strict";var nn=require("events"),rn=require("https"),on=require("http"),jt=require("net"),an=require("tls"),{randomBytes:cn,createHash:ln}=require("crypto"),{Duplex:dr,Readable:hr}=require("stream"),{URL:Ge}=require("url"),R=ie(),dn=je(),hn=Ve(),{isBlob:un}=Y(),{BINARY_TYPES:Ut,EMPTY_BUFFER:_e,GUID:fn,kForOnEventAttribute:Ke,kListener:pn,kStatusCode:gn,kWebSocket:_,NOOP:Ht}=I(),{EventTarget:{addEventListener:mn,removeEventListener:bn}}=At(),{format:vn,parse:yn}=ze(),{toBuffer:_n}=ne(),xn=30*1e3,qt=Symbol("kAborted"),Ye=[8,13],N=["CONNECTING","OPEN","CLOSING","CLOSED"],wn=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/,m=class n extends nn{constructor(e,t,s){super(),this._binaryType=Ut[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=_e,this._closeTimer=null,this._errorEmitted=!1,this._extensions={},this._paused=!1,this._protocol="",this._readyState=n.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,e!==null?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,t===void 0?t=[]:Array.isArray(t)||(typeof t=="object"&&t!==null?(s=t,t=[]):t=[t]),Vt(this,e,t,s)):(this._autoPong=s.autoPong,this._isServer=!0)}get binaryType(){return this._binaryType}set binaryType(e){Ut.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,s){let r=new dn({allowSynchronousEvents:s.allowSynchronousEvents,binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:s.maxPayload,skipUTF8Validation:s.skipUTF8Validation}),i=new hn(e,this._extensions,s.generateMask);this._receiver=r,this._sender=i,this._socket=e,r[_]=this,i[_]=this,e[_]=this,r.on("conclude",En),r.on("drain",Pn),r.on("error",Cn),r.on("message",Tn),r.on("ping",Mn),r.on("pong",Fn),i.onerror=Bn,e.setTimeout&&e.setTimeout(0),e.setNoDelay&&e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",Gt),e.on("data",we),e.on("end",Kt),e.on("error",Yt),this._readyState=n.OPEN,this.emit("open")}emitClose(){if(!this._socket){this._readyState=n.CLOSED,this.emit("close",this._closeCode,this._closeMessage);return}this._extensions[R.extensionName]&&this._extensions[R.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=n.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==n.CLOSED){if(this.readyState===n.CONNECTING){k(this,this._req,"WebSocket was closed before the connection was established");return}if(this.readyState===n.CLOSING){this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end();return}this._readyState=n.CLOSING,this._sender.close(e,t,!this._isServer,s=>{s||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())}),zt(this)}}pause(){this.readyState===n.CONNECTING||this.readyState===n.CLOSED||(this._paused=!0,this._socket.pause())}ping(e,t,s){if(this.readyState===n.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof e=="function"?(s=e,e=t=void 0):typeof t=="function"&&(s=t,t=void 0),typeof e=="number"&&(e=e.toString()),this.readyState!==n.OPEN){Qe(this,e,s);return}t===void 0&&(t=!this._isServer),this._sender.ping(e||_e,t,s)}pong(e,t,s){if(this.readyState===n.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof e=="function"?(s=e,e=t=void 0):typeof t=="function"&&(s=t,t=void 0),typeof e=="number"&&(e=e.toString()),this.readyState!==n.OPEN){Qe(this,e,s);return}t===void 0&&(t=!this._isServer),this._sender.pong(e||_e,t,s)}resume(){this.readyState===n.CONNECTING||this.readyState===n.CLOSED||(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(e,t,s){if(this.readyState===n.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof t=="function"&&(s=t,t={}),typeof e=="number"&&(e=e.toString()),this.readyState!==n.OPEN){Qe(this,e,s);return}let r={binary:typeof e!="string",mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[R.extensionName]||(r.compress=!1),this._sender.send(e||_e,r,s)}terminate(){if(this.readyState!==n.CLOSED){if(this.readyState===n.CONNECTING){k(this,this._req,"WebSocket was closed before the connection was established");return}this._socket&&(this._readyState=n.CLOSING,this._socket.destroy())}}};Object.defineProperty(m,"CONNECTING",{enumerable:!0,value:N.indexOf("CONNECTING")});Object.defineProperty(m.prototype,"CONNECTING",{enumerable:!0,value:N.indexOf("CONNECTING")});Object.defineProperty(m,"OPEN",{enumerable:!0,value:N.indexOf("OPEN")});Object.defineProperty(m.prototype,"OPEN",{enumerable:!0,value:N.indexOf("OPEN")});Object.defineProperty(m,"CLOSING",{enumerable:!0,value:N.indexOf("CLOSING")});Object.defineProperty(m.prototype,"CLOSING",{enumerable:!0,value:N.indexOf("CLOSING")});Object.defineProperty(m,"CLOSED",{enumerable:!0,value:N.indexOf("CLOSED")});Object.defineProperty(m.prototype,"CLOSED",{enumerable:!0,value:N.indexOf("CLOSED")});["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach(n=>{Object.defineProperty(m.prototype,n,{enumerable:!0})});["open","error","close","message"].forEach(n=>{Object.defineProperty(m.prototype,`on${n}`,{enumerable:!0,get(){for(let e of this.listeners(n))if(e[Ke])return e[pn];return null},set(e){for(let t of this.listeners(n))if(t[Ke]){this.removeListener(n,t);break}typeof e=="function"&&this.addEventListener(n,e,{[Ke]:!0})}})});m.prototype.addEventListener=mn;m.prototype.removeEventListener=bn;Qt.exports=m;function Vt(n,e,t,s){let r={allowSynchronousEvents:!0,autoPong:!0,protocolVersion:Ye[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...s,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(n._autoPong=r.autoPong,!Ye.includes(r.protocolVersion))throw new RangeError(`Unsupported protocol version: ${r.protocolVersion} (supported versions: ${Ye.join(", ")})`);let i;if(e instanceof Ge)i=e;else try{i=new Ge(e)}catch{throw new SyntaxError(`Invalid URL: ${e}`)}i.protocol==="http:"?i.protocol="ws:":i.protocol==="https:"&&(i.protocol="wss:"),n._url=i.href;let o=i.protocol==="wss:",a=i.protocol==="ws+unix:",l;if(i.protocol!=="ws:"&&!o&&!a?l=`The URL's protocol must be one of "ws:", "wss:", "http:", "https:", or "ws+unix:"`:a&&!i.pathname?l="The URL's pathname is empty":i.hash&&(l="The URL contains a fragment identifier"),l){let u=new SyntaxError(l);if(n._redirects===0)throw u;xe(n,u);return}let c=o?443:80,d=cn(16).toString("base64"),h=o?rn.request:on.request,p=new Set,b;if(r.createConnection=r.createConnection||(o?kn:Sn),r.defaultPort=r.defaultPort||c,r.port=i.port||c,r.host=i.hostname.startsWith("[")?i.hostname.slice(1,-1):i.hostname,r.headers={...r.headers,"Sec-WebSocket-Version":r.protocolVersion,"Sec-WebSocket-Key":d,Connection:"Upgrade",Upgrade:"websocket"},r.path=i.pathname+i.search,r.timeout=r.handshakeTimeout,r.perMessageDeflate&&(b=new R(r.perMessageDeflate!==!0?r.perMessageDeflate:{},!1,r.maxPayload),r.headers["Sec-WebSocket-Extensions"]=vn({[R.extensionName]:b.offer()})),t.length){for(let u of t){if(typeof u!="string"||!wn.test(u)||p.has(u))throw new SyntaxError("An invalid or duplicated subprotocol was specified");p.add(u)}r.headers["Sec-WebSocket-Protocol"]=t.join(",")}if(r.origin&&(r.protocolVersion<13?r.headers["Sec-WebSocket-Origin"]=r.origin:r.headers.Origin=r.origin),(i.username||i.password)&&(r.auth=`${i.username}:${i.password}`),a){let u=r.path.split(":");r.socketPath=u[0],r.path=u[1]}let v;if(r.followRedirects){if(n._redirects===0){n._originalIpc=a,n._originalSecure=o,n._originalHostOrSocketPath=a?r.socketPath:i.host;let u=s&&s.headers;if(s={...s,headers:{}},u)for(let[x,$]of Object.entries(u))s.headers[x.toLowerCase()]=$}else if(n.listenerCount("redirect")===0){let u=a?n._originalIpc?r.socketPath===n._originalHostOrSocketPath:!1:n._originalIpc?!1:i.host===n._originalHostOrSocketPath;(!u||n._originalSecure&&!o)&&(delete r.headers.authorization,delete r.headers.cookie,u||delete r.headers.host,r.auth=void 0)}r.auth&&!s.headers.authorization&&(s.headers.authorization="Basic "+Buffer.from(r.auth).toString("base64")),v=n._req=h(r),n._redirects&&n.emit("redirect",n.url,v)}else v=n._req=h(r);r.timeout&&v.on("timeout",()=>{k(n,v,"Opening handshake has timed out")}),v.on("error",u=>{v===null||v[qt]||(v=n._req=null,xe(n,u))}),v.on("response",u=>{let x=u.headers.location,$=u.statusCode;if(x&&r.followRedirects&&$>=300&&$<400){if(++n._redirects>r.maxRedirects){k(n,v,"Maximum redirects exceeded");return}v.abort();let te;try{te=new Ge(x,e)}catch{let z=new SyntaxError(`Invalid URL: ${x}`);xe(n,z);return}Vt(n,te,t,s)}else n.emit("unexpected-response",v,u)||k(n,v,`Unexpected server response: ${u.statusCode}`)}),v.on("upgrade",(u,x,$)=>{if(n.emit("upgrade",u),n.readyState!==m.CONNECTING)return;v=n._req=null;let te=u.headers.upgrade;if(te===void 0||te.toLowerCase()!=="websocket"){k(n,x,"Invalid Upgrade header");return}let st=ln("sha1").update(d+fn).digest("base64");if(u.headers["sec-websocket-accept"]!==st){k(n,x,"Invalid Sec-WebSocket-Accept header");return}let z=u.headers["sec-websocket-protocol"],se;if(z!==void 0?p.size?p.has(z)||(se="Server sent an invalid subprotocol"):se="Server sent a subprotocol but none was requested":p.size&&(se="Server sent no subprotocol"),se){k(n,x,se);return}z&&(n._protocol=z);let nt=u.headers["sec-websocket-extensions"];if(nt!==void 0){if(!b){k(n,x,"Server sent a Sec-WebSocket-Extensions header but no extension was requested");return}let Me;try{Me=yn(nt)}catch{k(n,x,"Invalid Sec-WebSocket-Extensions header");return}let rt=Object.keys(Me);if(rt.length!==1||rt[0]!==R.extensionName){k(n,x,"Server indicated an extension that was not requested");return}try{b.accept(Me[R.extensionName])}catch{k(n,x,"Invalid Sec-WebSocket-Extensions header");return}n._extensions[R.extensionName]=b}n.setSocket(x,$,{allowSynchronousEvents:r.allowSynchronousEvents,generateMask:r.generateMask,maxPayload:r.maxPayload,skipUTF8Validation:r.skipUTF8Validation})}),r.finishRequest?r.finishRequest(v,n):v.end()}function xe(n,e){n._readyState=m.CLOSING,n._errorEmitted=!0,n.emit("error",e),n.emitClose()}function Sn(n){return n.path=n.socketPath,jt.connect(n)}function kn(n){return n.path=void 0,!n.servername&&n.servername!==""&&(n.servername=jt.isIP(n.host)?"":n.host),an.connect(n)}function k(n,e,t){n._readyState=m.CLOSING;let s=new Error(t);Error.captureStackTrace(s,k),e.setHeader?(e[qt]=!0,e.abort(),e.socket&&!e.socket.destroyed&&e.socket.destroy(),process.nextTick(xe,n,s)):(e.destroy(s),e.once("error",n.emit.bind(n,"error")),e.once("close",n.emitClose.bind(n)))}function Qe(n,e,t){if(e){let s=un(e)?e.size:_n(e).length;n._socket?n._sender._bufferedBytes+=s:n._bufferedAmount+=s}if(t){let s=new Error(`WebSocket is not open: readyState ${n.readyState} (${N[n.readyState]})`);process.nextTick(t,s)}}function En(n,e){let t=this[_];t._closeFrameReceived=!0,t._closeMessage=e,t._closeCode=n,t._socket[_]!==void 0&&(t._socket.removeListener("data",we),process.nextTick($t,t._socket),n===1005?t.close():t.close(n,e))}function Pn(){let n=this[_];n.isPaused||n._socket.resume()}function Cn(n){let e=this[_];e._socket[_]!==void 0&&(e._socket.removeListener("data",we),process.nextTick($t,e._socket),e.close(n[gn])),e._errorEmitted||(e._errorEmitted=!0,e.emit("error",n))}function Wt(){this[_].emitClose()}function Tn(n,e){this[_].emit("message",n,e)}function Mn(n){let e=this[_];e._autoPong&&e.pong(n,!this._isServer,Ht),e.emit("ping",n)}function Fn(n){this[_].emit("pong",n)}function $t(n){n.resume()}function Bn(n){let e=this[_];e.readyState!==m.CLOSED&&(e.readyState===m.OPEN&&(e._readyState=m.CLOSING,zt(e)),this._socket.end(),e._errorEmitted||(e._errorEmitted=!0,e.emit("error",n)))}function zt(n){n._closeTimer=setTimeout(n._socket.destroy.bind(n._socket),xn)}function Gt(){let n=this[_];this.removeListener("close",Gt),this.removeListener("data",we),this.removeListener("end",Kt),n._readyState=m.CLOSING;let e;!this._readableState.endEmitted&&!n._closeFrameReceived&&!n._receiver._writableState.errorEmitted&&(e=n._socket.read())!==null&&n._receiver.write(e),n._receiver.end(),this[_]=void 0,clearTimeout(n._closeTimer),n._receiver._writableState.finished||n._receiver._writableState.errorEmitted?n.emitClose():(n._receiver.on("error",Wt),n._receiver.on("finish",Wt))}function we(n){this[_]._receiver.write(n)||this.pause()}function Kt(){let n=this[_];n._readyState=m.CLOSING,n._receiver.end(),this.end()}function Yt(){let n=this[_];this.removeListener("error",Yt),this.on("error",Ht),n&&(n._readyState=m.CLOSING,this.destroy())}});var es=S((pr,Xt)=>{"use strict";var fr=Se(),{Duplex:In}=require("stream");function Jt(n){n.emit("close")}function On(){!this.destroyed&&this._writableState.finished&&this.destroy()}function Zt(n){this.removeListener("error",Zt),this.destroy(),this.listenerCount("error")===0&&this.emit("error",n)}function Dn(n,e){let t=!0,s=new In({...e,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return n.on("message",function(i,o){let a=!o&&s._readableState.objectMode?i.toString():i;s.push(a)||n.pause()}),n.once("error",function(i){s.destroyed||(t=!1,s.destroy(i))}),n.once("close",function(){s.destroyed||s.push(null)}),s._destroy=function(r,i){if(n.readyState===n.CLOSED){i(r),process.nextTick(Jt,s);return}let o=!1;n.once("error",function(l){o=!0,i(l)}),n.once("close",function(){o||i(r),process.nextTick(Jt,s)}),t&&n.terminate()},s._final=function(r){if(n.readyState===n.CONNECTING){n.once("open",function(){s._final(r)});return}n._socket!==null&&(n._socket._writableState.finished?(r(),s._readableState.endEmitted&&s.destroy()):(n._socket.once("finish",function(){r()}),n.close()))},s._read=function(){n.isPaused&&n.resume()},s._write=function(r,i,o){if(n.readyState===n.CONNECTING){n.once("open",function(){s._write(r,i,o)});return}n.send(r,o)},s.on("end",On),s.on("error",Zt),s}Xt.exports=Dn});var ss=S((gr,ts)=>{"use strict";var{tokenChars:Nn}=Y();function Ln(n){let e=new Set,t=-1,s=-1,r=0;for(r;r<n.length;r++){let o=n.charCodeAt(r);if(s===-1&&Nn[o]===1)t===-1&&(t=r);else if(r!==0&&(o===32||o===9))s===-1&&t!==-1&&(s=r);else if(o===44){if(t===-1)throw new SyntaxError(`Unexpected character at index ${r}`);s===-1&&(s=r);let a=n.slice(t,s);if(e.has(a))throw new SyntaxError(`The "${a}" subprotocol is duplicated`);e.add(a),t=s=-1}else throw new SyntaxError(`Unexpected character at index ${r}`)}if(t===-1||s!==-1)throw new SyntaxError("Unexpected end of input");let i=n.slice(t,r);if(e.has(i))throw new SyntaxError(`The "${i}" subprotocol is duplicated`);return e.add(i),e}ts.exports={parse:Ln}});var ls=S((br,cs)=>{"use strict";var An=require("events"),ke=require("http"),{Duplex:mr}=require("stream"),{createHash:Rn}=require("crypto"),ns=ze(),q=ie(),Un=ss(),Wn=Se(),{GUID:jn,kWebSocket:Hn}=I(),qn=/^[+/0-9A-Za-z]{22}==$/,rs=0,is=1,as=2,Je=class extends An{constructor(e,t){if(super(),e={allowSynchronousEvents:!0,autoPong:!0,maxPayload:100*1024*1024,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:Wn,...e},e.port==null&&!e.server&&!e.noServer||e.port!=null&&(e.server||e.noServer)||e.server&&e.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(e.port!=null?(this._server=ke.createServer((s,r)=>{let i=ke.STATUS_CODES[426];r.writeHead(426,{"Content-Length":i.length,"Content-Type":"text/plain"}),r.end(i)}),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server){let s=this.emit.bind(this,"connection");this._removeListeners=Vn(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(r,i,o)=>{this.handleUpgrade(r,i,o,s)}})}e.perMessageDeflate===!0&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set,this._shouldEmitClose=!1),this.options=e,this._state=rs}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(this._state===as){e&&this.once("close",()=>{e(new Error("The server is not running"))}),process.nextTick(le,this);return}if(e&&this.once("close",e),this._state!==is)if(this._state=is,this.options.noServer||this.options.server)this._server&&(this._removeListeners(),this._removeListeners=this._server=null),this.clients?this.clients.size?this._shouldEmitClose=!0:process.nextTick(le,this):process.nextTick(le,this);else{let t=this._server;this._removeListeners(),this._removeListeners=this._server=null,t.close(()=>{le(this)})}}shouldHandle(e){if(this.options.path){let t=e.url.indexOf("?");if((t!==-1?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,s,r){t.on("error",os);let i=e.headers["sec-websocket-key"],o=e.headers.upgrade,a=+e.headers["sec-websocket-version"];if(e.method!=="GET"){V(this,e,t,405,"Invalid HTTP method");return}if(o===void 0||o.toLowerCase()!=="websocket"){V(this,e,t,400,"Invalid Upgrade header");return}if(i===void 0||!qn.test(i)){V(this,e,t,400,"Missing or invalid Sec-WebSocket-Key header");return}if(a!==13&&a!==8){V(this,e,t,400,"Missing or invalid Sec-WebSocket-Version header",{"Sec-WebSocket-Version":"13, 8"});return}if(!this.shouldHandle(e)){de(t,400);return}let l=e.headers["sec-websocket-protocol"],c=new Set;if(l!==void 0)try{c=Un.parse(l)}catch{V(this,e,t,400,"Invalid Sec-WebSocket-Protocol header");return}let d=e.headers["sec-websocket-extensions"],h={};if(this.options.perMessageDeflate&&d!==void 0){let p=new q(this.options.perMessageDeflate,!0,this.options.maxPayload);try{let b=ns.parse(d);b[q.extensionName]&&(p.accept(b[q.extensionName]),h[q.extensionName]=p)}catch{V(this,e,t,400,"Invalid or unacceptable Sec-WebSocket-Extensions header");return}}if(this.options.verifyClient){let p={origin:e.headers[`${a===8?"sec-websocket-origin":"origin"}`],secure:!!(e.socket.authorized||e.socket.encrypted),req:e};if(this.options.verifyClient.length===2){this.options.verifyClient(p,(b,v,u,x)=>{if(!b)return de(t,v||401,u,x);this.completeUpgrade(h,i,c,e,t,s,r)});return}if(!this.options.verifyClient(p))return de(t,401)}this.completeUpgrade(h,i,c,e,t,s,r)}completeUpgrade(e,t,s,r,i,o,a){if(!i.readable||!i.writable)return i.destroy();if(i[Hn])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>rs)return de(i,503);let c=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${Rn("sha1").update(t+jn).digest("base64")}`],d=new this.options.WebSocket(null,void 0,this.options);if(s.size){let h=this.options.handleProtocols?this.options.handleProtocols(s,r):s.values().next().value;h&&(c.push(`Sec-WebSocket-Protocol: ${h}`),d._protocol=h)}if(e[q.extensionName]){let h=e[q.extensionName].params,p=ns.format({[q.extensionName]:[h]});c.push(`Sec-WebSocket-Extensions: ${p}`),d._extensions=e}this.emit("headers",c,r),i.write(c.concat(`\r
`).join(`\r
`)),i.removeListener("error",os),d.setSocket(i,o,{allowSynchronousEvents:this.options.allowSynchronousEvents,maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients&&(this.clients.add(d),d.on("close",()=>{this.clients.delete(d),this._shouldEmitClose&&!this.clients.size&&process.nextTick(le,this)})),a(d,r)}};cs.exports=Je;function Vn(n,e){for(let t of Object.keys(e))n.on(t,e[t]);return function(){for(let s of Object.keys(e))n.removeListener(s,e[s])}}function le(n){n._state=as,n.emit("close")}function os(){this.destroy()}function de(n,e,t,s){t=t||ke.STATUS_CODES[e],s={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(t),...s},n.once("finish",n.destroy),n.end(`HTTP/1.1 ${e} ${ke.STATUS_CODES[e]}\r
`+Object.keys(s).map(r=>`${r}: ${s[r]}`).join(`\r
`)+`\r
\r
`+t)}function V(n,e,t,s,r,i){if(n.listenerCount("wsClientError")){let o=new Error(r);Error.captureStackTrace(o,V),n.emit("wsClientError",o,t,e)}else de(t,s,r,i)}});var Zn={};ks(Zn,{activate:()=>Yn,deactivate:()=>Jn});module.exports=Es(Zn);var f=w(require("vscode"));var $n=w(es(),1),zn=w(je(),1),Gn=w(Ve(),1),ds=w(Se(),1),Kn=w(ls(),1);var Ee=ds.default;var Xe=class{constructor(e="ws://localhost:8000/ws/nexus"){this.ws=null;this.connected=!1;this.reconnectAttempts=0;this.maxReconnectAttempts=10;this.reconnectDelay=2e3;this.messageHandlers=[];this.connectionHandlers=[];this.pendingRequests=new Map;this.messageQueue=[];this.heartbeatInterval=null;this.heartbeatTimeout=3e4;this.wsUrl=e}startHeartbeat(){this.stopHeartbeat(),this.heartbeatInterval=setInterval(()=>{this.connected&&this.ws&&this.sendRaw({type:"heartbeat",timestamp:new Date().toISOString()})},this.heartbeatTimeout)}stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)}onMessage(e){this.messageHandlers.push(e)}onConnectionChange(e){this.connectionHandlers.push(e)}notifyConnectionChange(e){this.connected=e;for(let t of this.connectionHandlers)t(e)}notifyMessage(e){for(let t of this.messageHandlers)t(e)}async connect(){return new Promise(e=>{try{this.ws=new Ee(this.wsUrl),this.ws.on("open",()=>{console.log("\u{1F50C} Forge Synapse verbunden"),this.connected=!0,this.reconnectAttempts=0,this.notifyConnectionChange(!0),this.startHeartbeat(),this.flushMessageQueue(),e(!0)}),this.ws.on("close",()=>{console.log("\u{1F50C} Forge Synapse getrennt"),this.connected=!1,this.stopHeartbeat(),this.notifyConnectionChange(!1),this.attemptReconnect()}),this.ws.on("error",t=>{console.error("\u{1F50C} Forge Synapse Fehler:",t),this.connected=!1,this.stopHeartbeat(),this.notifyConnectionChange(!1),e(!1)}),this.ws.on("message",t=>{try{let s=JSON.parse(t.toString());this.handleMessage(s)}catch(s){console.error("Fehler beim Parsen der Nachricht:",s)}})}catch(t){console.error("Verbindungsfehler:",t),e(!1)}})}handleMessage(e){if(e.type!=="heartbeat_ack"){if(e.type==="final_answer"||e.type==="response"||e.type==="chat_response"||e.type==="plan_response")for(let[t,s]of this.pendingRequests.entries()){this.pendingRequests.delete(t),s(e);return}if(e.data){let t=e.data?.request_id;if(t&&this.pendingRequests.has(t)){let s=this.pendingRequests.get(t);this.pendingRequests.delete(t),s(e);return}}this.notifyMessage(e)}}flushMessageQueue(){for(;this.messageQueue.length>0;){let e=this.messageQueue.shift();this.sendRaw(e)}}attemptReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){console.log("\u{1F50C} Max Reconnect-Versuche erreicht");return}this.reconnectAttempts++,console.log(`\u{1F50C} Reconnect Versuch ${this.reconnectAttempts}/${this.maxReconnectAttempts}`),setTimeout(()=>{this.connect()},this.reconnectDelay*this.reconnectAttempts)}disconnect(){this.stopHeartbeat(),this.ws&&(this.ws.close(),this.ws=null),this.connected=!1,this.notifyConnectionChange(!1)}isConnected(){return this.connected&&this.ws?.readyState===Ee.OPEN}sendRaw(e){if(!this.ws||this.ws.readyState!==Ee.OPEN)return this.messageQueue.push(e),!1;try{return this.ws.send(JSON.stringify(e)),!0}catch(t){return console.error("Fehler beim Senden:",t),this.messageQueue.push(e),!1}}async sendAndWait(e,t=6e4){return new Promise((s,r)=>{let i=this.generateRequestId(),o={...e,request_id:i},a=setTimeout(()=>{this.pendingRequests.delete(i),r(new Error("Timeout beim Warten auf Antwort"))},t);this.pendingRequests.set(i,l=>{clearTimeout(a),s(l)}),this.sendRaw(o)||this.connect().then(l=>{l||(clearTimeout(a),this.pendingRequests.delete(i),r(new Error("Keine Verbindung zur Forge")))})})}generateRequestId(){return"req_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}async chat(e,t=[],s=[]){let r={type:"chat_message",content:e,data:{history:t,attachments:s},timestamp:new Date().toISOString()};return this.sendAndWait(r)}async createPlan(e,t){let s={type:"create_plan",content:e,data:{context:t},timestamp:new Date().toISOString()};return this.sendAndWait(s,12e4)}async executeStep(e,t){let s={type:"execute_step",data:{plan_id:e,step_id:t},timestamp:new Date().toISOString()};return this.sendAndWait(s,18e4)}async readFile(e){let t={type:"read_file",file_path:e,timestamp:new Date().toISOString()};return this.sendAndWait(t)}async writeFile(e,t){let s={type:"write_file",file_path:e,content:t,timestamp:new Date().toISOString()};return this.sendAndWait(s)}async analyzeFile(e){let t={type:"analyze_file",file_path:e,timestamp:new Date().toISOString()};return this.sendAndWait(t)}async executeCode(e,t="python"){let s={type:"execute_code",code:e,data:{language:t},timestamp:new Date().toISOString()};return this.sendAndWait(s)}async createProject(e,t,s){let r={type:"create_project",project:e,data:{description:t,requirements:s},timestamp:new Date().toISOString()};return this.sendAndWait(r,3e5)}async getStatus(){let e={type:"status",timestamp:new Date().toISOString()};return this.sendAndWait(e,5e3)}async getMasters(){let e={type:"get_masters",timestamp:new Date().toISOString()};return this.sendAndWait(e,5e3)}},Ze=null;function hs(n){return Ze||(Ze=new Xe(n)),Ze}var U=w(require("vscode")),Pe=class{constructor(e,t,s,r){this.extensionUri=e;this.forgeClient=t;this.fileHandler=s;this.devAccess=r;this.tabs=[];this.activeTabId="";this.maxTabs=10;this.isConnected=!1;this.isExecuting=!1;this.createTab("Chat 1")}static{this.viewType="kyberion.chatView"}get messageHistory(){let e=this.getActiveTab();return e?e.messageHistory:[]}set messageHistory(e){let t=this.getActiveTab();t&&(t.messageHistory=e)}get attachedFiles(){let e=this.getActiveTab();return e?e.attachedFiles:[]}set attachedFiles(e){let t=this.getActiveTab();t&&(t.attachedFiles=e)}get isPlanMode(){let e=this.getActiveTab();return e?e.isPlanMode:!1}set isPlanMode(e){let t=this.getActiveTab();t&&(t.isPlanMode=e)}get currentPlan(){let e=this.getActiveTab();return e?e.currentPlan:null}set currentPlan(e){let t=this.getActiveTab();t&&(t.currentPlan=e)}createTab(e){let t=`tab_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,s=e||`Chat ${this.tabs.length+1}`,r={id:t,name:s,messageHistory:[],attachedFiles:[],isPlanMode:!1,currentPlan:null,createdAt:new Date};return this.tabs.push(r),this.activeTabId=t,console.log(`\u{1F4D1} Tab erstellt: ${s}`),r}getActiveTab(){return this.tabs.find(e=>e.id===this.activeTabId)}switchTab(e){let t=this.tabs.find(s=>s.id===e);t&&(this.activeTabId=e,this.syncTabToWebview(),console.log(`\u{1F4D1} Tab gewechselt: ${t.name}`))}renameTab(e,t){let s=this.tabs.find(r=>r.id===e);s&&(s.name=t,this.postMessage({type:"tabsUpdated",tabs:this.getTabsInfo(),activeTabId:this.activeTabId}))}closeTab(e){if(this.tabs.length<=1){U.window.showWarningMessage("Mindestens ein Tab muss offen bleiben");return}let t=this.tabs.findIndex(s=>s.id===e);t!==-1&&(this.tabs.splice(t,1),this.activeTabId===e?(this.activeTabId=this.tabs[Math.min(t,this.tabs.length-1)].id,this.syncTabToWebview()):this.postMessage({type:"tabsUpdated",tabs:this.getTabsInfo(),activeTabId:this.activeTabId}))}getTabsInfo(){return this.tabs.map(e=>({id:e.id,name:e.name,messageCount:e.messageHistory.length}))}syncTabToWebview(){let e=this.getActiveTab();e&&(this.postMessage({type:"tabsUpdated",tabs:this.getTabsInfo(),activeTabId:this.activeTabId}),this.postMessage({type:"tabContent",messages:e.messageHistory,attachedFiles:e.attachedFiles.map(t=>t.name),isPlanMode:e.isPlanMode,plan:e.currentPlan}))}resolveWebviewView(e,t,s){this.view=e,e.webview.options={enableScripts:!0,localResourceRoots:[this.extensionUri]},e.webview.html=this.getHtmlForWebview(e.webview),setTimeout(()=>{let r=this.forgeClient.isConnected();this.isConnected=r,this.postMessage({type:"connectionStatus",connected:r}),this.syncTabToWebview()},100),e.webview.onDidReceiveMessage(async r=>{switch(r.type){case"sendMessage":await this.handleSendMessage(r.message);break;case"connect":await this.handleConnect();break;case"disconnect":this.handleDisconnect();break;case"toggleMode":this.togglePlanMode();break;case"createPlan":await this.handleCreatePlan(r.message);break;case"startExecution":await this.startPlanExecution();break;case"pauseExecution":this.pausePlanExecution();break;case"resumeExecution":await this.resumePlanExecution();break;case"attachFile":await this.handleAttachFile();break;case"removeAttachment":this.removeAttachment(r.index);break;case"clearChat":this.clearChat();break;case"newTab":this.tabs.length<this.maxTabs?(this.createTab(),this.syncTabToWebview()):U.window.showWarningMessage(`Maximal ${this.maxTabs} Tabs erlaubt`);break;case"switchTab":this.switchTab(r.tabId);break;case"closeTab":this.closeTab(r.tabId);break;case"renameTab":this.renameTab(r.tabId,r.name);break}})}updateConnectionStatus(e){this.isConnected=e,this.postMessage({type:"connectionStatus",connected:e})}togglePlanMode(){this.isPlanMode=!this.isPlanMode,this.postMessage({type:"modeChanged",isPlanMode:this.isPlanMode})}handleForgeMessage(e){e.type==="thought"?this.postMessage({type:"thought",content:e.content,agent:e.agent}):e.type==="agent_activity"&&this.postMessage({type:"agentActivity",agent:e.agent,action:e.content})}analyzeFile(e,t){let s=e.split("/").pop()||e;this.attachedFiles.push({name:s,content:t}),this.postMessage({type:"fileAttached",files:this.attachedFiles.map(i=>i.name)});let r="Bitte analysiere diese Datei: "+s;this.handleSendMessage(r)}async handleSendMessage(e){if(!this.isConnected){this.postMessage({type:"error",message:"Nicht verbunden. Bitte zuerst verbinden."});return}let t=e;if(this.attachedFiles.length>0){t+=`

--- Angeh\xE4ngte Dateien ---
`;for(let s of this.attachedFiles)t+=`
### `+s.name+":\n```\n"+s.content+"\n```\n";this.attachedFiles=[],this.postMessage({type:"fileAttached",files:[]})}this.postMessage({type:"userMessage",message:e}),this.messageHistory.push({role:"user",content:e}),this.postMessage({type:"thinking",isThinking:!0});try{let s=await this.forgeClient.chat(t,this.messageHistory);if(this.postMessage({type:"thinking",isThinking:!1}),s){let r=s.content||"";this.messageHistory.push({role:"assistant",content:r}),this.postMessage({type:"assistantMessage",message:r,thinking:s.thinking,tools:s.data?.tools_used})}else this.postMessage({type:"error",message:"Keine Antwort vom Server."})}catch(s){this.postMessage({type:"thinking",isThinking:!1}),this.postMessage({type:"error",message:"Fehler: "+String(s)})}}async handleConnect(){this.postMessage({type:"connecting"});let e=await this.forgeClient.connect();this.updateConnectionStatus(e),e||this.postMessage({type:"error",message:"Verbindung fehlgeschlagen. L\xE4uft die Forge auf Port 8000?"})}handleDisconnect(){this.forgeClient.disconnect(),this.updateConnectionStatus(!1)}async handleAttachFile(){let e=await U.window.showOpenDialog({canSelectMany:!0,openLabel:"Anh\xE4ngen",filters:{"Alle Dateien":["*"],Code:["py","ts","js","tsx","jsx","json","html","css"],Text:["txt","md","rtf"],Dokumente:["pdf"]}});if(e&&e.length>0){for(let t of e)try{let s=await U.workspace.fs.readFile(t),r=new TextDecoder("utf-8").decode(s),i=t.fsPath.split("/").pop()||t.fsPath;this.attachedFiles.push({name:i,content:r}),console.log("\u{1F4CE} Datei angeh\xE4ngt:",i)}catch(s){console.error("Fehler beim Lesen der Datei:",t.fsPath,s),U.window.showErrorMessage(`Konnte Datei nicht lesen: ${t.fsPath}`)}this.attachedFiles.length>0&&(this.postMessage({type:"fileAttached",files:this.attachedFiles.map(t=>t.name)}),U.window.showInformationMessage(`${this.attachedFiles.length} Datei(en) angeh\xE4ngt`))}}removeAttachment(e){this.attachedFiles.splice(e,1),this.postMessage({type:"fileAttached",files:this.attachedFiles.map(t=>t.name)})}clearChat(){this.messageHistory=[],this.attachedFiles=[],this.currentPlan=null,this.postMessage({type:"chatCleared"})}async handleCreatePlan(e){if(!this.isConnected){this.postMessage({type:"error",message:"Nicht verbunden."});return}this.postMessage({type:"thinking",isThinking:!0,message:"Erstelle Plan..."});try{let t=await this.forgeClient.createPlan(e);if(this.postMessage({type:"thinking",isThinking:!1}),t&&t.plan)this.currentPlan=t.plan,this.postMessage({type:"planCreated",plan:t.plan});else if(t&&t.content){let s=this.extractPlanFromResponse(t.content,e);this.currentPlan=s,this.postMessage({type:"planCreated",plan:s})}}catch(t){this.postMessage({type:"thinking",isThinking:!1}),this.postMessage({type:"error",message:"Plan-Erstellung fehlgeschlagen: "+String(t)})}}extractPlanFromResponse(e,t){try{let s=e.match(/\{[\s\S]*"steps"[\s\S]*\}/);if(s){let r=JSON.parse(s[0]);return{id:"plan-"+Date.now(),title:r.title||"Plan",goal:r.goal||t,steps:(r.steps||[]).map((i,o)=>({id:i.id||o+1,title:i.title||"Schritt "+(o+1),description:i.description||"",status:"pending"})),currentStepIndex:0,status:"draft"}}}catch{console.log("JSON-Parsing fehlgeschlagen, erstelle einfachen Plan")}return{id:"plan-"+Date.now(),title:"Plan f\xFCr: "+t.substring(0,50),goal:t,steps:[{id:1,title:"Aufgabe analysieren",description:t,status:"pending"}],currentStepIndex:0,status:"draft"}}async startPlanExecution(){!this.currentPlan||this.isExecuting||(this.isExecuting=!0,this.currentPlan.status="running",this.postMessage({type:"executionStarted"}),await this.executeNextStep())}async executeNextStep(){if(!this.currentPlan||!this.isExecuting)return;let e=this.currentPlan.currentStepIndex;if(e>=this.currentPlan.steps.length){this.currentPlan.status="completed",this.isExecuting=!1,this.postMessage({type:"executionCompleted",plan:this.currentPlan});return}let t=this.currentPlan.steps[e];t.status="in-progress",this.postMessage({type:"stepStarted",stepIndex:e,step:t});try{let s=this.currentPlan.steps.slice(0,e).filter(i=>i.status==="completed").map(i=>i.title+": "+(i.result||"OK")).join(`
`),r=await this.forgeClient.executeStep(this.currentPlan.id,t.id);if(r)t.status="completed",t.result=r.content||"Schritt abgeschlossen",r.files_created&&(t.files_created=r.files_created),r.files_modified&&(t.files_modified=r.files_modified),this.postMessage({type:"stepCompleted",stepIndex:e,step:t}),this.currentPlan.currentStepIndex++,await new Promise(i=>setTimeout(i,500)),await this.executeNextStep();else throw new Error("Keine Antwort vom Server")}catch(s){t.status="failed",t.error=String(s),this.currentPlan.status="failed",this.isExecuting=!1,this.postMessage({type:"stepFailed",stepIndex:e,step:t,error:String(s)})}}pausePlanExecution(){this.isExecuting=!1,this.currentPlan&&(this.currentPlan.status="paused"),this.postMessage({type:"executionPaused"})}async resumePlanExecution(){this.currentPlan&&(this.isExecuting=!0,this.currentPlan.status="running",this.postMessage({type:"executionResumed"}),await this.executeNextStep())}postMessage(e){this.view&&this.view.webview.postMessage(e)}getHtmlForWebview(e){let t=[];return t.push("<!DOCTYPE html>"),t.push('<html lang="de">'),t.push("<head>"),t.push('<meta charset="UTF-8">'),t.push('<meta name="viewport" content="width=device-width, initial-scale=1.0">'),t.push("<title>Kyberion Chat</title>"),t.push("<style>"),t.push(this.getStyles()),t.push("</style>"),t.push("</head>"),t.push("<body>"),t.push(this.getBodyHtml()),t.push("<script>"),t.push(this.getScript()),t.push("</script>"),t.push("</body>"),t.push("</html>"),t.join(`
`)}getStyles(){return["* { box-sizing: border-box; margin: 0; padding: 0; }","body { font-family: var(--vscode-font-family); background: var(--vscode-editor-background); color: var(--vscode-editor-foreground); height: 100vh; display: flex; flex-direction: column; }","/* Header */",".header { padding: 10px; border-bottom: 1px solid var(--vscode-panel-border); display: flex; align-items: center; gap: 10px; }",".status-dot { width: 10px; height: 10px; border-radius: 50%; background: #dc3545; }",".status-dot.connected { background: #28a745; }",".header-title { flex: 1; font-weight: bold; }","/* Mode Toggle */",".mode-toggle { display: flex; border-radius: 6px; overflow: hidden; border: 1px solid var(--vscode-button-border); }",".mode-btn { padding: 6px 12px; background: transparent; color: var(--vscode-button-foreground); border: none; cursor: pointer; font-size: 12px; }",".mode-btn.active { background: var(--vscode-button-background); }",".mode-btn:hover { background: var(--vscode-button-hoverBackground); }","/* Chat Container */",".chat-container { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 12px; }","/* Messages */",".message { max-width: 85%; padding: 10px 14px; border-radius: 12px; line-height: 1.5; }",".message.user { align-self: flex-end; background: var(--vscode-button-background); color: var(--vscode-button-foreground); border-bottom-right-radius: 4px; }",".message.assistant { align-self: flex-start; background: var(--vscode-input-background); border: 1px solid var(--vscode-input-border); border-bottom-left-radius: 4px; }",".message.error { background: #dc354520; border: 1px solid #dc3545; color: #dc3545; }","/* Thinking Animation */",".thinking { display: none; align-items: center; gap: 8px; padding: 10px; color: var(--vscode-descriptionForeground); }",".thinking.visible { display: flex; }",".thinking-dots { display: flex; gap: 4px; }",".thinking-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--vscode-button-background); animation: bounce 1.4s infinite ease-in-out both; }",".thinking-dot:nth-child(1) { animation-delay: -0.32s; }",".thinking-dot:nth-child(2) { animation-delay: -0.16s; }","@keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }","/* Thinking Collapsible */",".thinking-content { margin-top: 8px; padding: 8px; background: var(--vscode-textBlockQuote-background); border-radius: 6px; font-size: 12px; color: var(--vscode-descriptionForeground); }",".thinking-toggle { cursor: pointer; color: var(--vscode-textLink-foreground); font-size: 11px; margin-top: 6px; }","/* Code Blocks */","pre { background: var(--vscode-textCodeBlock-background); padding: 10px; border-radius: 6px; overflow-x: auto; margin: 8px 0; }","code { font-family: var(--vscode-editor-font-family); font-size: 13px; }","/* Plan View */",".plan-container { display: none; flex: 1; overflow-y: auto; padding: 10px; }",".plan-container.visible { display: block; }",".plan-header { font-size: 16px; font-weight: bold; margin-bottom: 10px; }",".plan-goal { color: var(--vscode-descriptionForeground); margin-bottom: 16px; font-size: 13px; }",".plan-steps { display: flex; flex-direction: column; gap: 10px; }",".plan-step { padding: 12px; background: var(--vscode-input-background); border: 1px solid var(--vscode-input-border); border-radius: 8px; }",".step-header { display: flex; align-items: center; gap: 8px; }",".step-status { font-size: 16px; }",".step-title { font-weight: 500; flex: 1; }",".step-description { font-size: 12px; color: var(--vscode-descriptionForeground); margin-top: 6px; }",".step-result { font-size: 12px; margin-top: 8px; padding: 8px; background: var(--vscode-textBlockQuote-background); border-radius: 4px; }","/* Attachments */",".attachments { display: flex; flex-wrap: wrap; gap: 6px; padding: 6px 10px; border-top: 1px solid var(--vscode-panel-border); }",".attachment { display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--vscode-badge-background); color: var(--vscode-badge-foreground); border-radius: 4px; font-size: 11px; }",".attachment-remove { cursor: pointer; opacity: 0.7; }",".attachment-remove:hover { opacity: 1; }","/* Input Area */",".input-area { padding: 10px; border-top: 1px solid var(--vscode-panel-border); }",".input-row { display: flex; gap: 8px; align-items: flex-end; }",".input-wrapper { flex: 1; display: flex; flex-direction: column; gap: 6px; }","textarea { width: 100%; min-height: 60px; max-height: 150px; padding: 10px; background: var(--vscode-input-background); color: var(--vscode-input-foreground); border: 1px solid var(--vscode-input-border); border-radius: 8px; resize: vertical; font-family: inherit; font-size: 13px; }","textarea:focus { outline: none; border-color: var(--vscode-focusBorder); }","/* Buttons */",".btn { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 6px; }",".btn-primary { background: #0078d4; color: white; }",".btn-primary:hover { background: #106ebe; }",".btn-secondary { background: var(--vscode-button-secondaryBackground); color: var(--vscode-button-secondaryForeground); }",".btn-secondary:hover { background: var(--vscode-button-secondaryHoverBackground); }",".btn-danger { background: #dc3545; color: white; }",".btn-danger:hover { background: #c82333; }",".btn-icon { padding: 8px; background: transparent; border: 1px solid var(--vscode-button-border); }",".btn-icon:hover { background: var(--vscode-button-hoverBackground); }",".btn:disabled { opacity: 0.5; cursor: not-allowed; }","/* Action Buttons (Plan Mode) */",".action-buttons { display: flex; gap: 8px; padding: 10px; border-top: 1px solid var(--vscode-panel-border); }",".action-buttons.hidden { display: none; }","/* Welcome */",".welcome { text-align: center; padding: 40px 20px; color: var(--vscode-descriptionForeground); }",".welcome-icon { font-size: 48px; margin-bottom: 16px; }",".welcome-title { font-size: 18px; font-weight: bold; color: var(--vscode-editor-foreground); margin-bottom: 8px; }",".welcome-text { font-size: 13px; line-height: 1.6; }","/* Tab Bar */",".tab-bar { display: flex; align-items: center; background: var(--vscode-tab-inactiveBackground); border-bottom: 1px solid var(--vscode-panel-border); overflow-x: auto; }",".tab-bar::-webkit-scrollbar { height: 4px; }",".tab-bar::-webkit-scrollbar-thumb { background: var(--vscode-scrollbarSlider-background); border-radius: 2px; }",".tab { display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: transparent; color: var(--vscode-tab-inactiveForeground); border: none; border-right: 1px solid var(--vscode-panel-border); cursor: pointer; font-size: 12px; white-space: nowrap; min-width: 80px; max-width: 150px; }",".tab:hover { background: var(--vscode-tab-hoverBackground); }",".tab.active { background: var(--vscode-tab-activeBackground); color: var(--vscode-tab-activeForeground); border-bottom: 2px solid var(--vscode-focusBorder); }",".tab-name { flex: 1; overflow: hidden; text-overflow: ellipsis; }",".tab-close { opacity: 0; font-size: 14px; padding: 2px 4px; border-radius: 3px; }",".tab:hover .tab-close { opacity: 0.7; }",".tab-close:hover { opacity: 1; background: var(--vscode-toolbar-hoverBackground); }",".tab-badge { background: var(--vscode-badge-background); color: var(--vscode-badge-foreground); padding: 2px 6px; border-radius: 10px; font-size: 10px; }",".new-tab-btn { padding: 8px 12px; background: transparent; color: var(--vscode-foreground); border: none; cursor: pointer; font-size: 16px; }",".new-tab-btn:hover { background: var(--vscode-tab-hoverBackground); }"].join(`
`)}getBodyHtml(){return["<!-- Tab Bar -->",'<div class="tab-bar" id="tabBar">','  <div class="tab active" data-tab-id="initial">','    <span class="tab-name">Chat 1</span>',`    <span class="tab-close" onclick="closeTab(event, 'initial')">\xD7</span>`,"  </div>",'  <button class="new-tab-btn" onclick="newTab()" title="Neuer Tab">+</button>',"</div>","","<!-- Header -->",'<div class="header">','  <div class="status-dot" id="statusDot"></div>','  <span class="header-title">Kyberion</span>','  <div class="mode-toggle">',`    <button class="mode-btn active" id="chatModeBtn" onclick="setMode('chat')">\u{1F4AC} Chat</button>`,`    <button class="mode-btn" id="planModeBtn" onclick="setMode('plan')">\u{1F4CB} Plan</button>`,"  </div>",'  <button class="btn btn-icon" onclick="toggleConnection()" id="connectBtn" title="Verbinden">\u{1F50C}</button>',"</div>","","<!-- Chat Container -->",'<div class="chat-container" id="chatContainer">','  <div class="welcome" id="welcome">','    <div class="welcome-icon">\u{1F31F}</div>','    <div class="welcome-title">Willkommen bei Kyberion</div>','    <div class="welcome-text">',"      Ich bin dein KI-Assistent.<br>","      Verbinde dich mit dem Backend und starte eine Konversation.","    </div>","  </div>","</div>","","<!-- Plan Container -->",'<div class="plan-container" id="planContainer">','  <div class="plan-header" id="planTitle">Neuen Plan erstellen</div>','  <div class="plan-goal" id="planGoal">Beschreibe eine Aufgabe und ich erstelle einen strukturierten Plan.</div>','  <div class="plan-steps" id="planSteps"></div>',"</div>","","<!-- Thinking Indicator -->",'<div class="thinking" id="thinking">','  <div class="thinking-dots">','    <div class="thinking-dot"></div>','    <div class="thinking-dot"></div>','    <div class="thinking-dot"></div>',"  </div>",'  <span id="thinkingText">Kyberion denkt...</span>',"</div>","","<!-- Attachments -->",'<div class="attachments" id="attachments" style="display: none;"></div>',"","<!-- Action Buttons (Plan Mode) -->",'<div class="action-buttons hidden" id="actionButtons">','  <button class="btn btn-primary" id="actBtn" onclick="startExecution()">\u25B6\uFE0F ACT Starten</button>','  <button class="btn btn-secondary" id="pauseBtn" onclick="pauseExecution()" style="display: none;">\u23F8\uFE0F Pause</button>','  <button class="btn btn-secondary" id="resumeBtn" onclick="resumeExecution()" style="display: none;">\u25B6\uFE0F Fortsetzen</button>','  <button class="btn btn-secondary" onclick="recreatePlan()">\u{1F504} Neu</button>',"</div>","","<!-- Input Area -->",'<div class="input-area">','  <div class="input-row">','    <button class="btn btn-icon" onclick="attachFile()" title="Datei anh\xE4ngen">\u{1F4CE}</button>','    <div class="input-wrapper">','      <textarea id="messageInput" placeholder="Nachricht eingeben..." onkeydown="handleKeyDown(event)"></textarea>',"    </div>",'    <button class="btn btn-primary" onclick="sendMessage()" id="sendBtn">\u27A4</button>',"  </div>","</div>"].join(`
`)}getScript(){return["const vscode = acquireVsCodeApi();","let isConnected = false;","let isPlanMode = false;","let currentPlan = null;","let activeTabId = null;","","// Elemente",'const tabBar = document.getElementById("tabBar");','const chatContainer = document.getElementById("chatContainer");','const planContainer = document.getElementById("planContainer");','const welcome = document.getElementById("welcome");','const thinking = document.getElementById("thinking");','const thinkingText = document.getElementById("thinkingText");','const statusDot = document.getElementById("statusDot");','const messageInput = document.getElementById("messageInput");','const attachmentsDiv = document.getElementById("attachments");','const actionButtons = document.getElementById("actionButtons");','const planSteps = document.getElementById("planSteps");','const planTitle = document.getElementById("planTitle");','const planGoal = document.getElementById("planGoal");',"","// ============ TAB FUNKTIONEN ============","","function newTab() {",'  vscode.postMessage({ type: "newTab" });',"}","","function switchTab(tabId) {","  if (tabId !== activeTabId) {",'    vscode.postMessage({ type: "switchTab", tabId: tabId });',"  }","}","","function closeTab(event, tabId) {","  event.stopPropagation();",'  vscode.postMessage({ type: "closeTab", tabId: tabId });',"}","","function renameTab(tabId) {",`  const tab = document.querySelector("[data-tab-id='" + tabId + "'] .tab-name");`,"  if (tab) {","    const currentName = tab.textContent;",'    const newName = prompt("Tab umbenennen:", currentName);',"    if (newName && newName.trim()) {",'      vscode.postMessage({ type: "renameTab", tabId: tabId, name: newName.trim() });',"    }","  }","}","","function updateTabs(tabs, newActiveTabId) {","  activeTabId = newActiveTabId;",'  const newTabBtn = tabBar.querySelector(".new-tab-btn");','  tabBar.innerHTML = "";',"  ","  tabs.forEach(function(tab) {",'    const tabEl = document.createElement("div");','    tabEl.className = "tab" + (tab.id === activeTabId ? " active" : "");','    tabEl.setAttribute("data-tab-id", tab.id);',"    tabEl.onclick = function() { switchTab(tab.id); };","    tabEl.ondblclick = function() { renameTab(tab.id); };","    ",'    const nameSpan = document.createElement("span");','    nameSpan.className = "tab-name";',"    nameSpan.textContent = tab.name;","    tabEl.appendChild(nameSpan);","    ","    if (tab.messageCount > 0) {",'      const badge = document.createElement("span");','      badge.className = "tab-badge";',"      badge.textContent = tab.messageCount;","      tabEl.appendChild(badge);","    }","    ",'    const closeBtn = document.createElement("span");','    closeBtn.className = "tab-close";','    closeBtn.textContent = "\xD7";',"    closeBtn.onclick = function(e) { closeTab(e, tab.id); };","    tabEl.appendChild(closeBtn);","    ","    tabBar.appendChild(tabEl);","  });","  ",'  const addBtn = document.createElement("button");','  addBtn.className = "new-tab-btn";','  addBtn.textContent = "+";','  addBtn.title = "Neuer Tab";',"  addBtn.onclick = newTab;","  tabBar.appendChild(addBtn);","}","","function loadTabContent(data) {","  // Chat leeren",'  chatContainer.innerHTML = "";',"  ","  // Willkommen anzeigen wenn leer","  if (!data.messages || data.messages.length === 0) {",'    const welcomeDiv = document.createElement("div");','    welcomeDiv.className = "welcome";','    welcomeDiv.id = "welcome";','    welcomeDiv.innerHTML = "<div class=\\"welcome-icon\\">\u{1F31F}</div><div class=\\"welcome-title\\">Willkommen bei Kyberion</div><div class=\\"welcome-text\\">Ich bin dein KI-Assistent.<br>Verbinde dich mit dem Backend und starte eine Konversation.</div>";',"    chatContainer.appendChild(welcomeDiv);","  } else {","    // Nachrichten laden","    data.messages.forEach(function(msg) {","      addMessage(msg.content, msg.role, { thinking: msg.thinking });","    });","  }","  ","  // Attachments","  if (data.attachedFiles && data.attachedFiles.length > 0) {",'    attachmentsDiv.style.display = "flex";',"    attachmentsDiv.innerHTML = data.attachedFiles.map(function(f, i) {",'      return "<div class=\\"attachment\\">\u{1F4C4} " + escapeHtml(f) + " <span class=\\"attachment-remove\\" onclick=\\"removeAttachment(" + i + ")\\">\xD7</span></div>";','    }).join("");',"  } else {",'    attachmentsDiv.style.display = "none";','    attachmentsDiv.innerHTML = "";',"  }","  ","  // Modus","  isPlanMode = data.isPlanMode || false;",'  setMode(isPlanMode ? "plan" : "chat");',"}","","// Modus wechseln","function setMode(mode) {",'  isPlanMode = mode === "plan";','  document.getElementById("chatModeBtn").classList.toggle("active", !isPlanMode);','  document.getElementById("planModeBtn").classList.toggle("active", isPlanMode);','  chatContainer.style.display = isPlanMode ? "none" : "flex";','  planContainer.classList.toggle("visible", isPlanMode);','  actionButtons.classList.toggle("hidden", !isPlanMode || !currentPlan);','  messageInput.placeholder = isPlanMode ? "Beschreibe die Aufgabe..." : "Nachricht eingeben...";',"}","","// Verbindung","function toggleConnection() {","  if (isConnected) {",'    vscode.postMessage({ type: "disconnect" });',"  } else {",'    vscode.postMessage({ type: "connect" });',"  }","}","","// Nachricht senden","function sendMessage() {","  const message = messageInput.value.trim();","  if (!message) return;","  ","  if (isPlanMode && !currentPlan) {",'    vscode.postMessage({ type: "createPlan", message: message });',"  } else {",'    vscode.postMessage({ type: "sendMessage", message: message });',"  }",'  messageInput.value = "";',"}","","// Tastatur-Handler","function handleKeyDown(event) {",'  if (event.key === "Enter" && !event.shiftKey) {',"    event.preventDefault();","    sendMessage();","  }","}","","// Datei anh\xE4ngen","function attachFile() {",'  vscode.postMessage({ type: "attachFile" });',"}","","// Plan-Ausf\xFChrung","function startExecution() {",'  vscode.postMessage({ type: "startExecution" });',"}","","function pauseExecution() {",'  vscode.postMessage({ type: "pauseExecution" });',"}","","function resumeExecution() {",'  vscode.postMessage({ type: "resumeExecution" });',"}","","function recreatePlan() {","  currentPlan = null;",'  planSteps.innerHTML = "";','  planTitle.textContent = "Neuen Plan erstellen";','  planGoal.textContent = "Beschreibe eine Aufgabe und ich erstelle einen strukturierten Plan.";','  actionButtons.classList.add("hidden");',"}","","// Nachricht hinzuf\xFCgen","function addMessage(content, type, extra) {",'  welcome.style.display = "none";',"  ",'  const msg = document.createElement("div");','  msg.className = "message " + type;',"  ","  // Markdown-\xE4hnliches Rendering","  let html = content;","  // Code-Bl\xF6cke","  html = html.replace(/```(\\w*)\\n([\\s\\S]*?)```/g, function(match, lang, code) {",'    return "<pre><code class=\\"language-" + lang + "\\">" + escapeHtml(code) + "</code></pre>";',"  });","  // Inline-Code",'  html = html.replace(/`([^`]+)`/g, "<code>$1</code>");',"  // Bold",'  html = html.replace(/\\*\\*([^*]+)\\*\\*/g, "<strong>$1</strong>");',"  // Newlines",'  html = html.replace(/\\n/g, "<br>");',"  ","  msg.innerHTML = html;","  ","  // Thinking anzeigen (collapsible)","  if (extra && extra.thinking) {",'    const thinkingDiv = document.createElement("div");','    thinkingDiv.className = "thinking-content";','    thinkingDiv.style.display = "none";',"    thinkingDiv.textContent = extra.thinking;","    ",'    const toggle = document.createElement("div");','    toggle.className = "thinking-toggle";','    toggle.textContent = "\u{1F4AD} Gedanken anzeigen";',"    toggle.onclick = function() {",'      const visible = thinkingDiv.style.display !== "none";','      thinkingDiv.style.display = visible ? "none" : "block";','      toggle.textContent = visible ? "\u{1F4AD} Gedanken anzeigen" : "\u{1F4AD} Gedanken verbergen";',"    };","    ","    msg.appendChild(toggle);","    msg.appendChild(thinkingDiv);","  }","  ","  chatContainer.appendChild(msg);","  chatContainer.scrollTop = chatContainer.scrollHeight;","}","","function escapeHtml(text) {",'  const div = document.createElement("div");',"  div.textContent = text;","  return div.innerHTML;","}","","// Status-Icon f\xFCr Plan-Schritt","function getStepStatusIcon(status) {","  switch(status) {",'    case "pending": return "\u23F3";','    case "in-progress": return "\u{1F504}";','    case "completed": return "\u2705";','    case "failed": return "\u274C";','    default: return "\u23F3";',"  }","}","","// Plan-Schritt rendern","function renderPlanStep(step) {",'  const div = document.createElement("div");','  div.className = "plan-step";','  div.id = "step-" + step.id;',"  ",'  let html = "<div class=\\"step-header\\">";','  html += "<span class=\\"step-status\\">" + getStepStatusIcon(step.status) + "</span>";','  html += "<span class=\\"step-title\\">Schritt " + step.id + ": " + escapeHtml(step.title) + "</span>";','  html += "</div>";',"  if (step.description) {",'    html += "<div class=\\"step-description\\">" + escapeHtml(step.description) + "</div>";',"  }","  if (step.result) {",'    html += "<div class=\\"step-result\\">\u2713 " + escapeHtml(step.result.substring(0, 200)) + "</div>";',"  }","  if (step.error) {",'    html += "<div class=\\"step-result\\" style=\\"color: #dc3545;\\">\u2717 " + escapeHtml(step.error) + "</div>";',"  }","  ","  div.innerHTML = html;","  return div;","}","","// Plan rendern","function renderPlan(plan) {","  currentPlan = plan;",'  planTitle.textContent = "\u{1F4CB} " + plan.title;',"  planGoal.textContent = plan.goal;",'  planSteps.innerHTML = "";',"  ","  for (const step of plan.steps) {","    planSteps.appendChild(renderPlanStep(step));","  }","  ",'  actionButtons.classList.remove("hidden");',"}","","// Schritt aktualisieren","function updateStep(stepIndex, step) {",'  const existing = document.getElementById("step-" + step.id);',"  if (existing) {","    existing.replaceWith(renderPlanStep(step));","  }","}","","// Nachrichten von Extension empfangen",'window.addEventListener("message", function(event) {',"  const data = event.data;","  ","  switch(data.type) {",'    case "connectionStatus":',"      isConnected = data.connected;",'      statusDot.classList.toggle("connected", isConnected);','      document.getElementById("connectBtn").title = isConnected ? "Trennen" : "Verbinden";',"      break;","    ",'    case "connecting":','      thinkingText.textContent = "Verbinde...";','      thinking.classList.add("visible");',"      break;","    ",'    case "thinking":',"      if (data.isThinking) {",'        thinkingText.textContent = data.message || "Kyberion denkt...";','        thinking.classList.add("visible");',"      } else {",'        thinking.classList.remove("visible");',"      }","      break;","    ",'    case "userMessage":','      addMessage(data.message, "user");',"      break;","    ",'    case "assistantMessage":','      addMessage(data.message, "assistant", { thinking: data.thinking, tools: data.tools });',"      break;","    ",'    case "error":','      addMessage(data.message, "error");',"      break;","    ",'    case "fileAttached":',"      if (data.files && data.files.length > 0) {",'        attachmentsDiv.style.display = "flex";',"        attachmentsDiv.innerHTML = data.files.map(function(f, i) {",'          return "<div class=\\"attachment\\">\u{1F4C4} " + escapeHtml(f) + " <span class=\\"attachment-remove\\" onclick=\\"removeAttachment(" + i + ")\\">\xD7</span></div>";','        }).join("");',"      } else {",'        attachmentsDiv.style.display = "none";','        attachmentsDiv.innerHTML = "";',"      }","      break;","    ",'    case "modeChanged":','      setMode(data.isPlanMode ? "plan" : "chat");',"      break;","    ",'    case "planCreated":',"      renderPlan(data.plan);",'      thinking.classList.remove("visible");',"      break;","    ",'    case "executionStarted":','      document.getElementById("actBtn").style.display = "none";','      document.getElementById("pauseBtn").style.display = "flex";','      document.getElementById("resumeBtn").style.display = "none";',"      break;","    ",'    case "stepStarted":','    case "stepCompleted":','    case "stepFailed":',"      updateStep(data.stepIndex, data.step);","      break;","    ",'    case "executionPaused":','      document.getElementById("actBtn").style.display = "none";','      document.getElementById("pauseBtn").style.display = "none";','      document.getElementById("resumeBtn").style.display = "flex";',"      break;","    ",'    case "executionResumed":','      document.getElementById("actBtn").style.display = "none";','      document.getElementById("pauseBtn").style.display = "flex";','      document.getElementById("resumeBtn").style.display = "none";',"      break;","    ",'    case "executionCompleted":','      document.getElementById("actBtn").style.display = "none";','      document.getElementById("pauseBtn").style.display = "none";','      document.getElementById("resumeBtn").style.display = "none";','      addMessage("\u2705 Plan erfolgreich abgeschlossen!", "assistant");',"      break;","    ",'    case "chatCleared":','      chatContainer.innerHTML = "";','      const welcomeEl = document.getElementById("welcome");',"      if (welcomeEl) {",'        welcomeEl.style.display = "block";',"        chatContainer.appendChild(welcomeEl);","      }","      recreatePlan();","      break;","    ","    // Tab-Events",'    case "tabsUpdated":',"      updateTabs(data.tabs, data.activeTabId);","      break;","    ",'    case "tabContent":',"      loadTabContent(data);","      break;","  }","});","","function removeAttachment(index) {",'  vscode.postMessage({ type: "removeAttachment", index: index });',"}"].join(`
`)}};var us=w(require("vscode")),F=w(require("fs")),L=w(require("path")),Ce=class{constructor(){let e=us.workspace.getConfiguration("kyberion");this.devDirectory=e.get("devDirectory")||"/Users/gregorklauss/dev"}async readFile(e){try{return this.isAllowedPath(e)?await F.promises.readFile(e,"utf-8"):(console.warn("Zugriff verweigert:",e),null)}catch(t){return console.error("Fehler beim Lesen:",t),null}}async writeFile(e,t){try{if(!this.isAllowedPath(e))return console.warn("Schreibzugriff verweigert:",e),!1;let s=L.dirname(e);return await F.promises.mkdir(s,{recursive:!0}),await F.promises.writeFile(e,t,"utf-8"),!0}catch(s){return console.error("Fehler beim Schreiben:",s),!1}}async createFile(e,t=""){return this.writeFile(e,t)}async deleteFile(e){try{return this.isAllowedPath(e)?(await F.promises.unlink(e),!0):(console.warn("L\xF6schzugriff verweigert:",e),!1)}catch(t){return console.error("Fehler beim L\xF6schen:",t),!1}}async createDirectory(e){try{return this.isAllowedPath(e)?(await F.promises.mkdir(e,{recursive:!0}),!0):(console.warn("Ordner-Erstellung verweigert:",e),!1)}catch(t){return console.error("Fehler beim Ordner erstellen:",t),!1}}async listDirectory(e){try{return this.isAllowedPath(e)?(await F.promises.readdir(e,{withFileTypes:!0})).map(s=>s.isDirectory()?s.name+"/":s.name):(console.warn("Ordner-Zugriff verweigert:",e),null)}catch(t){return console.error("Fehler beim Auflisten:",t),null}}async exists(e){try{return await F.promises.access(e),!0}catch{return!1}}async rename(e,t){try{return!this.isAllowedPath(e)||!this.isAllowedPath(t)?(console.warn("Umbenennen verweigert:",e,"->",t),!1):(await F.promises.rename(e,t),!0)}catch(s){return console.error("Fehler beim Umbenennen:",s),!1}}async getFileInfo(e){try{let t=await F.promises.stat(e);return{path:e,name:L.basename(e),extension:L.extname(e),size:t.size,isDirectory:t.isDirectory(),modifiedAt:t.mtime,createdAt:t.birthtime}}catch(t){return console.error("Fehler beim Info-Abruf:",t),null}}isAllowedPath(e){return L.normalize(e).startsWith(this.devDirectory)}getLanguageForFile(e){let t=L.extname(e).toLowerCase();return{".py":"python",".ts":"typescript",".js":"javascript",".tsx":"typescriptreact",".jsx":"javascriptreact",".json":"json",".md":"markdown",".html":"html",".css":"css",".scss":"scss",".yaml":"yaml",".yml":"yaml",".xml":"xml",".sql":"sql",".sh":"shellscript",".bash":"shellscript",".zsh":"shellscript",".txt":"plaintext",".rtf":"plaintext",".pdf":"pdf"}[t]||"plaintext"}};var gs=w(require("vscode")),y=w(require("fs")),g=w(require("path")),fs=w(require("https")),ps=w(require("http")),ms=require("child_process"),Te=class{constructor(){this.backgroundProcesses=new Map;this.watchedDirectories=new Map;this.paths={dev:"/Users/gregorklauss/dev",kybernetikon:"/Users/gregorklauss/dev/kybernetikon-complete",forge:"/Users/gregorklauss/dev/kybernetikon-complete/kybernetikon_forge",projects:"/Users/gregorklauss/dev/kybernetikon-complete/projects",vault:"/Users/gregorklauss/dev/kybernetikon-complete/vault",sigils:"/Users/gregorklauss/dev/kybernetikon-complete/sigils",memories:"/Users/gregorklauss/dev/kybernetikon-complete/Memories",obsidian:"/Users/gregorklauss/dev/kybernetikon-complete/obsidian_vault",papasForschung:"/Users/gregorklauss/dev/Papas_Forschung"};let e=gs.workspace.getConfiguration("kyberion");this.devRoot=e.get("devDirectory")||"/Users/gregorklauss/dev",this.permissions={read:!0,write:!0,delete:!0,execute:!0,apiAccess:!0,backgroundProcesses:!0},console.log("\u{1F513} DevAccessManager initialisiert mit vollen Berechtigungen")}async readFile(e){try{let t=this.resolvePath(e);return await y.promises.readFile(t,"utf-8")}catch(t){return console.error("\u{1F4C1} Lesefehler:",t),null}}async readBinaryFile(e){try{let t=this.resolvePath(e);return await y.promises.readFile(t)}catch(t){return console.error("\u{1F4C1} Bin\xE4r-Lesefehler:",t),null}}async writeFile(e,t){try{let s=this.resolvePath(e),r=g.dirname(s);return await y.promises.mkdir(r,{recursive:!0}),await y.promises.writeFile(s,t,"utf-8"),console.log("\u2705 Geschrieben:",s),!0}catch(s){return console.error("\u{1F4C1} Schreibfehler:",s),!1}}async writeBinaryFile(e,t){try{let s=this.resolvePath(e),r=g.dirname(s);return await y.promises.mkdir(r,{recursive:!0}),await y.promises.writeFile(s,t),!0}catch(s){return console.error("\u{1F4C1} Bin\xE4r-Schreibfehler:",s),!1}}async deleteFile(e){try{let t=this.resolvePath(e);return await y.promises.unlink(t),console.log("\u{1F5D1}\uFE0F Gel\xF6scht:",t),!0}catch(t){return console.error("\u{1F4C1} L\xF6schfehler:",t),!1}}async createDirectory(e){try{let t=this.resolvePath(e);return await y.promises.mkdir(t,{recursive:!0}),console.log("\u{1F4C1} Ordner erstellt:",t),!0}catch(t){return console.error("\u{1F4C1} Ordner-Fehler:",t),!1}}async deleteDirectory(e){try{let t=this.resolvePath(e);return await y.promises.rm(t,{recursive:!0,force:!0}),console.log("\u{1F5D1}\uFE0F Ordner gel\xF6scht:",t),!0}catch(t){return console.error("\u{1F4C1} Ordner-L\xF6schfehler:",t),!1}}async move(e,t){try{let s=this.resolvePath(e),r=this.resolvePath(t);return await y.promises.mkdir(g.dirname(r),{recursive:!0}),await y.promises.rename(s,r),console.log("\u{1F4E6} Verschoben:",s,"->",r),!0}catch(s){return console.error("\u{1F4C1} Verschiebe-Fehler:",s),!1}}async copy(e,t){try{let s=this.resolvePath(e),r=this.resolvePath(t);return await y.promises.mkdir(g.dirname(r),{recursive:!0}),await y.promises.copyFile(s,r),console.log("\u{1F4CB} Kopiert:",s,"->",r),!0}catch(s){return console.error("\u{1F4C1} Kopier-Fehler:",s),!1}}async listDirectory(e,t=!1){try{let s=this.resolvePath(e);return t?await this.listRecursive(s,s):(await y.promises.readdir(s,{withFileTypes:!0})).map(i=>i.isDirectory()?i.name+"/":i.name)}catch(s){return console.error("\u{1F4C1} Auflistungs-Fehler:",s),[]}}async listRecursive(e,t){let s=[],r=await y.promises.readdir(t,{withFileTypes:!0});for(let i of r){let o=g.join(t,i.name),a=g.relative(e,o);if(i.isDirectory()){if(s.push(a+"/"),!["node_modules",".git","__pycache__",".venv","venv"].includes(i.name)){let l=await this.listRecursive(e,o);s.push(...l)}}else s.push(a)}return s}async searchFiles(e,t){let s=t?this.resolvePath(t):this.devRoot,r=[],i=new RegExp(e,"i");try{let o=await this.listDirectory(s,!0);for(let a of o){if(a.endsWith("/"))continue;let l=g.join(s,a),c=g.basename(a);i.test(c)&&r.push({path:l,name:c,matches:[c],score:1})}}catch(o){console.error("\u{1F50D} Suchfehler:",o)}return r}async searchInFiles(e,t,s){let r=t?this.resolvePath(t):this.devRoot,i=[];try{let o=await this.listDirectory(r,!0);for(let a of o){if(a.endsWith("/"))continue;if(s&&s.length>0){let d=g.extname(a);if(!s.includes(d))continue}let l=g.join(r,a),c=await this.readFile(l);if(c&&c.includes(e)){let d=c.split(`
`),h=[];d.forEach((p,b)=>{p.includes(e)&&h.push(`Zeile ${b+1}: ${p.trim().substring(0,100)}`)}),i.push({path:l,name:g.basename(a),matches:h,score:h.length})}}}catch(o){console.error("\u{1F50D} Inhaltssuch-Fehler:",o)}return i.sort((o,a)=>a.score-o.score)}async httpGet(e){return new Promise(t=>{(e.startsWith("https")?fs:ps).get(e,r=>{let i="";r.on("data",o=>i+=o),r.on("end",()=>t(i))}).on("error",r=>{console.error("\u{1F310} HTTP-Fehler:",r),t(null)})})}async httpPost(e,t){return new Promise(s=>{let r=new URL(e),i=e.startsWith("https")?fs:ps,o=JSON.stringify(t),a={hostname:r.hostname,port:r.port||(e.startsWith("https")?443:80),path:r.pathname,method:"POST",headers:{"Content-Type":"application/json","Content-Length":Buffer.byteLength(o)}},l=i.request(a,c=>{let d="";c.on("data",h=>d+=h),c.on("end",()=>s(d))});l.on("error",c=>{console.error("\u{1F310} HTTP POST-Fehler:",c),s(null)}),l.write(o),l.end()})}startBackgroundProcess(e,t,s=[],r){try{let i=r?this.resolvePath(r):this.devRoot,o=(0,ms.spawn)(t,s,{cwd:i,detached:!0,stdio:"ignore"});o.unref();let a={id:`bg_${Date.now()}`,name:e,pid:o.pid||0,startTime:new Date,status:"running"};return this.backgroundProcesses.set(a.id,o),console.log("\u{1F504} Hintergrund-Prozess gestartet:",e,"PID:",o.pid),a}catch(i){return console.error("\u{1F504} Prozess-Start-Fehler:",i),null}}stopBackgroundProcess(e){let t=this.backgroundProcesses.get(e);return t?(t.kill(),this.backgroundProcesses.delete(e),console.log("\u23F9\uFE0F Hintergrund-Prozess gestoppt:",e),!0):!1}listBackgroundProcesses(){let e=[];for(let[t,s]of this.backgroundProcesses)e.push({id:t,name:t,pid:s.pid||0,startTime:new Date,status:s.killed?"stopped":"running"});return e}watchDirectory(e,t){try{let s=this.resolvePath(e),r=y.watch(s,{recursive:!0},(i,o)=>{o&&t(i,o)});return this.watchedDirectories.set(s,r),console.log("\u{1F441}\uFE0F \xDCberwachung gestartet:",s),!0}catch(s){return console.error("\u{1F441}\uFE0F \xDCberwachungs-Fehler:",s),!1}}unwatchDirectory(e){let t=this.resolvePath(e),s=this.watchedDirectories.get(t);return s?(s.close(),this.watchedDirectories.delete(t),console.log("\u{1F441}\uFE0F \xDCberwachung gestoppt:",t),!0):!1}async readSigil(e){let t=g.join(this.paths.sigils,`${e}.json`),s=await this.readFile(t);return s?JSON.parse(s):null}async writeSigil(e,t){let s=g.join(this.paths.sigils,`${e}.json`);return await this.writeFile(s,JSON.stringify(t,null,2))}async listSigils(){return(await this.listDirectory(this.paths.sigils)).filter(t=>t.endsWith(".json")).map(t=>t.replace(".json",""))}async saveMemory(e,t){let s=g.join(this.paths.memories,e,`${Date.now()}.json`);return await this.writeFile(s,JSON.stringify(t,null,2))}async readObsidianNote(e){let t=g.join(this.paths.obsidian,e);return await this.readFile(t)}async writeObsidianNote(e,t){let s=g.join(this.paths.obsidian,e);return await this.writeFile(s,t)}async listProjects(){return(await this.listDirectory(this.paths.projects)).filter(t=>t.endsWith("/"))}async analyzeProject(e){let t=g.join(this.paths.projects,e),s=await this.listDirectory(t,!0),r={name:e,path:t,totalFiles:s.filter(i=>!i.endsWith("/")).length,totalDirs:s.filter(i=>i.endsWith("/")).length,fileTypes:{},structure:s};for(let i of s)if(!i.endsWith("/")){let o=g.extname(i)||"no-extension";r.fileTypes[o]=(r.fileTypes[o]||0)+1}return r}resolvePath(e){return g.isAbsolute(e)?e:g.join(this.devRoot,e)}async exists(e){try{return await y.promises.access(this.resolvePath(e)),!0}catch{return!1}}async getFileInfo(e){try{return await y.promises.stat(this.resolvePath(e))}catch{return null}}getPermissions(){return{...this.permissions}}dispose(){for(let e of this.watchedDirectories.values())e.close();this.watchedDirectories.clear();for(let[e]of this.backgroundProcesses)this.stopBackgroundProcess(e);console.log("\u{1F513} DevAccessManager disposed")}};var T,ee,tt,et,B;function Yn(n){console.log("Kyberion Forge Extension wird aktiviert...");let e=f.workspace.getConfiguration("kyberion"),t=e.get("forgeWsUrl")||"ws://localhost:8000/ws/nexus",s=e.get("autoConnect")??!0;T=hs(t),tt=new Ce,et=new Te,global.kyberionDevAccess=et,ee=new Pe(n.extensionUri,T,tt,et),n.subscriptions.push(f.window.registerWebviewViewProvider("kyberion.chatView",ee,{webviewOptions:{retainContextWhenHidden:!0}})),B=f.window.createStatusBarItem(f.StatusBarAlignment.Right,100),B.command="kyberion.showStatus",bs(!1),B.show(),n.subscriptions.push(B),Qn(n),T.onConnectionChange(r=>{bs(r),ee.updateConnectionStatus(r)}),T.onMessage(r=>{(r.type==="thought"||r.type==="agent_activity")&&ee.handleForgeMessage(r)}),s&&T.connect().then(r=>{r&&f.window.showInformationMessage("Kyberion Forge verbunden!")}),console.log("\u{1F513} Kyberion Forge Extension aktiviert mit vollen DEV-Berechtigungen!")}function Qn(n){n.subscriptions.push(f.commands.registerCommand("kyberion.openChat",()=>{f.commands.executeCommand("kyberion.chatView.focus")})),n.subscriptions.push(f.commands.registerCommand("kyberion.connect",async()=>{await T.connect()?f.window.showInformationMessage("Kyberion Forge verbunden!"):f.window.showErrorMessage("Verbindung fehlgeschlagen")})),n.subscriptions.push(f.commands.registerCommand("kyberion.disconnect",()=>{T.disconnect(),f.window.showInformationMessage("Forge getrennt.")})),n.subscriptions.push(f.commands.registerCommand("kyberion.analyzeFile",async e=>{let t=e;if(!t&&f.window.activeTextEditor&&(t=f.window.activeTextEditor.document.uri),t){let s=await tt.readFile(t.fsPath);s&&(ee.analyzeFile(t.fsPath,s),f.commands.executeCommand("kyberion.chatView.focus"))}})),n.subscriptions.push(f.commands.registerCommand("kyberion.showStatus",async()=>{if(!T.isConnected()){f.window.showWarningMessage("Forge nicht verbunden");return}try{let e=await T.getStatus();f.window.showInformationMessage("Forge Status OK")}catch{f.window.showErrorMessage("Status Fehler")}})),n.subscriptions.push(f.commands.registerCommand("kyberion.togglePlanMode",()=>{ee.togglePlanMode()}))}function bs(n){n?(B.text="$(flame) Forge",B.tooltip="Kyberion Forge verbunden",B.backgroundColor=void 0):(B.text="$(debug-disconnect) Forge",B.tooltip="Forge getrennt",B.backgroundColor=new f.ThemeColor("statusBarItem.errorBackground"))}function Jn(){T&&T.disconnect()}0&&(module.exports={activate,deactivate});
